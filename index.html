<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Provvigioni Extra</title>

  <link rel="icon" type="image/svg+xml" href="icon.svg">

  <style>
    :root{
      --bg:#070A12;
      --text:#EAF0FF;
      --muted:#9AA6C0;
      --line: rgba(120, 150, 255, .18);
      --danger:#FF5A7A;
      --ok:#35F2A6;
      --warn:#FFC04D;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:26px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(124,246,255,.10), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(177,140,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #050711);
      color: var(--text);
    }
    .wrap{ max-width: 1200px; margin: 0 auto; }
    .title{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .title h1{ margin:0; font-size: 20px; letter-spacing: .3px; text-shadow: 0 0 14px rgba(124,246,255,.25); }
    .badge{
      padding:6px 10px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); border-radius: 999px;
      color: var(--muted); font-size: 12px;
    }
    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius: 14px;
      padding: 16px;
      box-shadow:
        0 0 0 1px rgba(124,246,255,.08),
        0 18px 50px rgba(0,0,0,.55),
        0 0 38px rgba(124,246,255,.12);
      backdrop-filter: blur(8px);
    }
    label{ display:block; margin: 10px 0 6px; color: var(--muted); font-size: 13px; }
    input, select, button{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(120,150,255,.22);
      background: rgba(10, 14, 28, .85);
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: rgba(154,166,192,.55); }
    input:focus, select:focus{
      border-color: rgba(124,246,255,.55);
      box-shadow: 0 0 0 3px rgba(124,246,255,.14);
    }
    input[readonly]{ background: rgba(255,255,255,.04); border-style: dashed; color: rgba(234,240,255,.92); }
    .grid{ display:grid; grid-template-columns: 1.1fr 1fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 680px){ .row2{ grid-template-columns: 1fr; } }
    .actions{ display:flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; align-items:center; }
    .btn{
      width:auto; padding: 10px 14px; cursor:pointer; white-space: nowrap;
      border: 1px solid rgba(124,246,255,.35);
      background: linear-gradient(180deg, rgba(124,246,255,.12), rgba(177,140,255,.10));
      box-shadow: 0 0 18px rgba(124,246,255,.14);
    }
    .btn.secondary{ border-color: rgba(177,140,255,.35); background: rgba(255,255,255,.03); }
    .btn.danger{ border-color: rgba(255,90,122,.45); background: rgba(255,90,122,.08); }
    .btn.warn{ border-color: rgba(255,192,77,.45); background: rgba(255,192,77,.08); }
    .msg{ margin-top: 10px; font-size: 13px; color: var(--muted); white-space: pre-wrap; }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--danger); }

    .toolbar{
      display:flex; gap: 10px; flex-wrap: wrap;
      align-items: end;
      margin-top: 16px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .tool{ min-width: 170px; flex: 1; }
    .tool.small{ min-width: 130px; max-width: 190px; flex: 0; }

    table{
      width:100%; border-collapse: collapse; margin-top: 12px;
      overflow:hidden; border-radius: 14px;
      border: 1px solid var(--line); background: rgba(6, 9, 18, .6);
    }
    th, td{ padding: 10px 10px; border-bottom: 1px solid rgba(120,150,255,.14); font-size: 13px; vertical-align: top; }
    th{
      text-align:left; color: rgba(234,240,255,.95);
      background: rgba(255,255,255,.03);
      position: sticky; top: 0; backdrop-filter: blur(6px); z-index: 1;
    }
    tr:hover td{ background: rgba(124,246,255,.04); }
    .mono{ font-variant-numeric: tabular-nums; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius: 999px;
      border:1px solid rgba(120,150,255,.22);
      background: rgba(255,255,255,.02);
      white-space: nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; box-shadow: 0 0 16px currentColor; display:inline-block; flex: 0 0 10px; }
    .cell-actions{ display:flex; gap:8px; flex-wrap: wrap; }
    .tiny{ width:auto; padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .paid-wrap{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .paid-wrap input[type="checkbox"]{ width:auto; }
    .paid-wrap input[type="date"]{ width:auto; padding: 8px 10px; border-radius: 10px; }
    .split{ display:flex; gap:10px; flex-wrap: wrap; align-items: end; }
    .split > *{ flex: 1; min-width: 180px; }
    .hidden{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>Provvigioni Extra</h1>
      <div class="badge">Produttori + Incentivazioni dinamiche · Firestore</div>
    </div>

    <div class="card">
      <form id="formProvvigioni">
        <div class="grid">
          <div>
            <div class="split">
              <div>
                <label for="produttoreSelect">Produttore</label>
                <select id="produttoreSelect" required>
                  <option value="" selected disabled>Caricamento...</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn secondary" type="button" id="btnNuovoProduttore">Inserisci nuovo produttore</button>
              </div>
            </div>

            <div class="split">
              <div>
                <label for="compagniaSelect">Compagnia</label>
                <select id="compagniaSelect" required>
                  <option value="" selected disabled>Seleziona...</option>
                  <option value="ALLIANZ">ALLIANZ</option>
                  <option value="HDI">HDI</option>
                  <option value="VITTORIA">VITTORIA</option>
                  <option value="ARAG">ARAG</option>
                  <option value="HELVETIA">HELVETIA</option>
                  <option value="GENIALPIU'">GENIALPIU'</option>
                  <option value="METLIFE">METLIFE</option>
                </select>
              </div>

              <div>
                <label for="tipoPolizzaSelect">Tipo polizza</label>
                <select id="tipoPolizzaSelect" required>
                  <option value="" selected disabled>Seleziona...</option>
                  <option value="NUOVA">Polizza nuova</option>
                  <option value="SOSTITUZIONE_AUMENTO">Sostituzione (premio in aumento)</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div>
                <label for="incentivazioneSelect">Incentivazione</label>
                <select id="incentivazioneSelect" required>
                  <option value="" selected disabled>Caricamento...</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn secondary" type="button" id="btnNuovaIncentivazione">Inserisci incentivazione</button>
              </div>
            </div>

            <label for="numeroPolizza">Numero di polizza</label>
            <input id="numeroPolizza" type="text" required placeholder="Es. 123456789" />
          </div>

          <div>
            <div class="row2">
              <div>
                <label for="premio">Premio</label>
                <input id="premio" type="number" step="0.01" min="0" required placeholder="0,00" />
              </div>
              <div>
                <label for="premioImponibile">Premio imponibile</label>
                <input id="premioImponibile" type="number" step="0.01" min="0" required placeholder="0,00" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label for="percentuale">% provvigioni (su imponibile)</label>
                <input id="percentuale" type="number" step="0.01" min="0" required placeholder="Es. 12,50" />
              </div>
              <div>
                <label for="provvigioni">Provvigioni calcolate</label>
                <input id="provvigioni" type="number" step="0.01" readonly placeholder="0,00" />
              </div>
            </div>

            <div class="actions">
              <button class="btn" type="button" id="btnInserisci">Inserisci & salva</button>
              <button class="btn secondary" type="reset" id="btnReset">Reset</button>
            </div>
            <div id="msg" class="msg"></div>
          </div>
        </div>
      </form>

      <div class="toolbar">
        <div class="tool">
          <label for="fProduttore">Filtro produttore</label>
          <select id="fProduttore">
            <option value="">Tutti</option>
          </select>
        </div>

        <div class="tool">
          <label for="fCompagnia">Compagnia</label>
          <select id="fCompagnia">
            <option value="">Tutte</option>
            <option value="ALLIANZ">ALLIANZ</option>
            <option value="HDI">HDI</option>
            <option value="VITTORIA">VITTORIA</option>
            <option value="ARAG">ARAG</option>
            <option value="HELVETIA">HELVETIA</option>
            <option value="GENIALPIU'">GENIALPIU'</option>
            <option value="METLIFE">METLIFE</option>
          </select>
        </div>

        <div class="tool">
          <label for="fTipoPolizza">Tipo polizza</label>
          <select id="fTipoPolizza">
            <option value="">Tutti</option>
            <option value="NUOVA">Polizza nuova</option>
            <option value="SOSTITUZIONE_AUMENTO">Sostituzione (premio in aumento)</option>
          </select>
        </div>

        <div class="tool">
          <label for="fIncentivazione">Incentivazione</label>
          <select id="fIncentivazione">
            <option value="">Tutte</option>
          </select>
        </div>

        <!-- PATCH: filtro pagate / da pagare / tutte -->
        <div class="tool small">
          <label for="fPagate">Pagamenti</label>
          <select id="fPagate">
            <option value="">Tutte</option>
            <option value="true">Pagate</option>
            <option value="false">Da pagare</option>
          </select>
        </div>

        <div class="tool small">
          <label for="fAnno">Anno</label>
          <select id="fAnno">
            <option value="">Tutti</option>
          </select>
        </div>

        <div class="tool small">
          <label for="fMese">Mese</label>
          <select id="fMese">
            <option value="">Tutti</option>
            <option value="1">Gen</option><option value="2">Feb</option><option value="3">Mar</option>
            <option value="4">Apr</option><option value="5">Mag</option><option value="6">Giu</option>
            <option value="7">Lug</option><option value="8">Ago</option><option value="9">Set</option>
            <option value="10">Ott</option><option value="11">Nov</option><option value="12">Dic</option>
          </select>
        </div>

        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnApplicaFiltri">Applica filtri</button>
        </div>

        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnExportExcel">Export Excel</button>
        </div>
      </div>

      <table id="tabella" class="hidden">
        <thead>
          <tr>
            <th>Data</th>
            <th>Titolo</th>
            <th>Produttore</th>
            <th>Compagnia</th>
            <th>Tipo</th>
            <th>Incentivazione</th>
            <th>Polizza</th>
            <th class="mono">Provvigioni</th>
            <th>Pagate</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="totaleBox" class="msg"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      query, where, orderBy, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBImpElnjCpYyMMrNh63xJDJ89Vxf3DIc",
      authDomain: "provvigioni-extra-allianz.firebaseapp.com",
      projectId: "provvigioni-extra-allianz",
      storageBucket: "provvigioni-extra-allianz.firebasestorage.app",
      messagingSenderId: "650627729378",
      appId: "1:650627729378:web:3e91c2a09dd071437c5bbb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const COL_EXTRA = "allianz_provvigioni_extra";
    const COL_PROD = "produttori";
    const COL_INC = "incentivazioni";

    const DEFAULT_PRODUTTORI = ["EVAN SGARBI","DUILIO FRARACCI","GINO POLIGANI","GIOVANNI CARERI","LUCA IORI","ANTONIO SENTIMENTI"];
    const DEFAULT_INCENTIVAZIONI = ["STANDARD"];

    const produttoreSelect = document.getElementById("produttoreSelect");
    const btnNuovoProduttore = document.getElementById("btnNuovoProduttore");

    const compagniaSelect = document.getElementById("compagniaSelect");
    const tipoPolizzaSelect = document.getElementById("tipoPolizzaSelect");

    const incentivazioneSelect = document.getElementById("incentivazioneSelect");
    const btnNuovaIncentivazione = document.getElementById("btnNuovaIncentivazione");

    const numeroPolizza = document.getElementById("numeroPolizza");
    const premio = document.getElementById("premio");
    const premioImponibile = document.getElementById("premioImponibile");
    const percentuale = document.getElementById("percentuale");
    const provvigioni = document.getElementById("provvigioni");

    const btnInserisci = document.getElementById("btnInserisci");
    const btnReset = document.getElementById("btnReset");
    const msg = document.getElementById("msg");

    const fProduttore = document.getElementById("fProduttore");
    const fCompagnia = document.getElementById("fCompagnia");
    const fTipoPolizza = document.getElementById("fTipoPolizza");
    const fIncentivazione = document.getElementById("fIncentivazione");
    const fPagate = document.getElementById("fPagate"); // PATCH
    const fAnno = document.getElementById("fAnno");
    const fMese = document.getElementById("fMese");
    const btnApplicaFiltri = document.getElementById("btnApplicaFiltri");

    const tabella = document.getElementById("tabella");
    const tbody = tabella.querySelector("tbody");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const totaleBox = document.getElementById("totaleBox");

    let produttori = [];
    let incentivazioni = [];
    let producerColorMap = {};
    let lastResults = [];

    function setMsg(type, text){
      msg.className = "msg" + (type ? " " + type : "");
      msg.textContent = text || "";
    }

    function toNumber(v){
      if (typeof v !== "string") v = String(v ?? "");
      v = v.replace(",", ".").trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function money2(n){ return (Math.round(n * 100) / 100).toFixed(2); }
    function pad2(n){ return String(n).padStart(2, "0"); }

    function colorForProducer(name){
      const palette = ["#7CF6FF","#B18CFF","#35F2A6","#FFC04D","#FF5A7A","#7CFFB2","#6CA8FF","#E0A6FF"];
      let h = 0;
      for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) >>> 0;
      return palette[h % palette.length];
    }

    function normalizeName(s){ return (s || "").trim().toUpperCase(); }

    function calcolaProvvigioni(){
      const imponibile = toNumber(premioImponibile.value);
      const perc = toNumber(percentuale.value);
      if (!Number.isFinite(imponibile) || !Number.isFinite(perc)) { provvigioni.value = ""; return; }
      provvigioni.value = money2(imponibile * (perc / 100));
    }

    premioImponibile.addEventListener("input", calcolaProvvigioni);
    percentuale.addEventListener("input", calcolaProvvigioni);

    btnReset.addEventListener("click", () => {
      setMsg("", "");
      provvigioni.value = "";
    });

    function mergeList(defaults, firestoreList){
      const set = new Map();
      defaults.forEach(n => set.set(normalizeName(n), { id: null, name: normalizeName(n) }));
      firestoreList.forEach(p => set.set(normalizeName(p.name), { id: p.id || null, name: normalizeName(p.name) }));
      return [...set.values()].sort((a,b)=>a.name.localeCompare(b.name));
    }

    function renderProduttori(){
      produttoreSelect.innerHTML =
        `<option value="" selected disabled>Seleziona...</option>` +
        produttori.map(p => `<option value="${p.name}">${p.name}</option>`).join("");

      fProduttore.innerHTML =
        `<option value="">Tutti</option>` +
        produttori.map(p => `<option value="${p.name}">${p.name}</option>`).join("");

      producerColorMap = {};
      produttori.forEach(p => producerColorMap[p.name] = colorForProducer(p.name));
    }

    function renderIncentivazioni(){
      incentivazioneSelect.innerHTML =
        `<option value="" selected disabled>Seleziona...</option>` +
        incentivazioni.map(p => `<option value="${p.name}">${p.name}</option>`).join("");

      fIncentivazione.innerHTML =
        `<option value="">Tutte</option>` +
        incentivazioni.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
    }

    async function loadProduttori(){
      try{
        const ref = collection(db, COL_PROD);
        const q = query(ref, orderBy("name", "asc"));
        const snap = await getDocs(q);
        const fs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.name);
        produttori = mergeList(DEFAULT_PRODUTTORI, fs);
        renderProduttori();
      }catch(e){
        console.error(e);
        produttori = mergeList(DEFAULT_PRODUTTORI, []);
        renderProduttori();
        setMsg("err", `Impossibile leggere produttori da Firestore.\n${e.code || ""} ${e.message || ""}`);
      }
    }

    async function loadIncentivazioni(){
      try{
        const ref = collection(db, COL_INC);
        const q = query(ref, orderBy("name", "asc"));
        const snap = await getDocs(q);
        const fs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.name);
        incentivazioni = mergeList(DEFAULT_INCENTIVAZIONI, fs);
        renderIncentivazioni();
      }catch(e){
        console.error(e);
        incentivazioni = mergeList(DEFAULT_INCENTIVAZIONI, []);
        renderIncentivazioni();
        setMsg("err", `Impossibile leggere incentivazioni da Firestore.\n${e.code || ""} ${e.message || ""}`);
      }
    }

    btnNuovoProduttore.addEventListener("click", async () => {
      const name = prompt("Inserisci nome nuovo produttore:");
      if (!name) return;
      const clean = normalizeName(name);
      if (!clean) return;

      if (produttori.some(p => p.name === clean)){
        setMsg("err", "Produttore già presente.");
        return;
      }

      try{
        await addDoc(collection(db, COL_PROD), { name: clean, createdAt: serverTimestamp() });
        setMsg("ok", "Produttore salvato.");
        await loadProduttori();
        produttoreSelect.value = clean;
      }catch(e){
        console.error(e);
        produttori = mergeList(DEFAULT_PRODUTTORI, [...produttori, { id:null, name: clean }]);
        renderProduttori();
        produttoreSelect.value = clean;
        setMsg("err", `Errore salvataggio produttore su Firestore.\n${e.code || ""} ${e.message || ""}`);
      }
    });

    btnNuovaIncentivazione.addEventListener("click", async () => {
      const name = prompt("Inserisci nuova incentivazione:");
      if (!name) return;
      const clean = normalizeName(name);
      if (!clean) return;

      if (incentivazioni.some(p => p.name === clean)){
        setMsg("err", "Incentivazione già presente.");
        return;
      }

      try{
        await addDoc(collection(db, COL_INC), { name: clean, createdAt: serverTimestamp() });
        setMsg("ok", "Incentivazione salvata.");
        await loadIncentivazioni();
        incentivazioneSelect.value = clean;
      }catch(e){
        console.error(e);
        incentivazioni = mergeList(DEFAULT_INCENTIVAZIONI, [...incentivazioni, { id:null, name: clean }]);
        renderIncentivazioni();
        incentivazioneSelect.value = clean;
        setMsg("err", `Errore salvataggio incentivazione su Firestore.\n${e.code || ""} ${e.message || ""}`);
      }
    });

    async function addRecord(){
      setMsg("", "");
      const form = document.getElementById("formProvvigioni");
      if (!form.reportValidity()) return;

      calcolaProvvigioni();

      const produttore = produttoreSelect.value;
      const compagnia = compagniaSelect.value;
      const tipoPolizza = tipoPolizzaSelect.value;
      const incentivazione = incentivazioneSelect.value;

      if (!produttore){ setMsg("err","Seleziona il produttore."); return; }
      if (!compagnia){ setMsg("err","Seleziona la compagnia."); return; }
      if (!tipoPolizza){ setMsg("err","Seleziona il tipo polizza."); return; }
      if (!incentivazione){ setMsg("err","Seleziona l'incentivazione."); return; }

      const numPolizza = numeroPolizza.value.trim();

      const premioVal = toNumber(premio.value);
      const imponibileVal = toNumber(premioImponibile.value);
      const percVal = toNumber(percentuale.value);
      const provvVal = toNumber(provvigioni.value);

      const d = new Date();
      const anno = d.getFullYear();
      const mese = d.getMonth() + 1;
      const dataiso = `${anno}-${pad2(mese)}-${pad2(d.getDate())}`;

      const titolo = `PROVVIGIONI EXTRA - ${numPolizza}`;

      const record = {
        titolo,
        produttore,
        compagnia,
        tipoPolizza,
        incentivazione,
        numeroPolizza: numPolizza,
        premio: premioVal,
        premioImponibile: imponibileVal,
        percentuale: percVal,
        provvigioni: provvVal,
        anno,
        mese,
        dataiso,
        pagate: false,
        pagateData: null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db, COL_EXTRA), record);
        setMsg("ok", "Inserito e salvato su Firestore.");
        form.reset();
        provvigioni.value = "";
        await loadByFilters();
      }catch(e){
        console.error(e);
        setMsg("err", `Errore salvataggio su Firestore.\n${e.code || ""} ${e.message || ""}`);
      }
    }

    btnInserisci.addEventListener("click", addRecord);

    function renderResults(rows){
      lastResults = rows;

      tbody.innerHTML = rows.map(r => {
        const c = producerColorMap[r.produttore] || "#7CF6FF";
        const checked = r.pagate ? "checked" : "";
        const dateVal = (r.pagateData && typeof r.pagateData === "string") ? r.pagateData : "";
        const disabledDate = r.pagate ? "" : "disabled";

        const tipoTxt =
          r.tipoPolizza === "SOSTITUZIONE_AUMENTO" ? "Sostituzione (aumento)" :
          r.tipoPolizza === "NUOVA" ? "Nuova" : (r.tipoPolizza ?? "");

        return `
          <tr>
            <td class="mono">${r.dataiso ?? ""}</td>
            <td>
              <div class="pill">
                <span class="dot" style="color:${c}; background:${c};"></span>
                <span>${r.titolo ?? ""}</span>
              </div>
            </td>
            <td>${r.produttore ?? ""}</td>
            <td>${r.compagnia ?? ""}</td>
            <td>${tipoTxt}</td>
            <td>${r.incentivazione ?? ""}</td>
            <td>${r.numeroPolizza ?? ""}</td>
            <td class="mono">${money2(Number(r.provvigioni ?? 0))}</td>
            <td>
              <div class="paid-wrap">
                <label style="margin:0; display:flex; align-items:center; gap:8px; color: var(--muted);">
                  <input type="checkbox" data-action="togglePaid" data-id="${r.id}" ${checked} />
                  Provvigioni pagate
                </label>
                <input type="date" data-action="paidDate" data-id="${r.id}" value="${dateVal}" ${disabledDate}/>
              </div>
            </td>
            <td>
              <div class="cell-actions">
                <button class="btn warn tiny" type="button" data-action="edit" data-id="${r.id}">Modifica</button>
                <button class="btn danger tiny" type="button" data-action="del" data-id="${r.id}">Elimina</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      tabella.classList.toggle("hidden", rows.length === 0);

      const tot = rows.reduce((s, r) => s + (Number(r.provvigioni) || 0), 0);
      totaleBox.className = "msg ok";
      totaleBox.textContent = `Totale provvigioni (filtri attivi): ${money2(tot)}`;

      const anni = [...new Set(rows.map(r => r.anno))].filter(Boolean).sort((a,b)=>b-a);
      const current = fAnno.value;
      fAnno.innerHTML = `<option value="">Tutti</option>` + anni.map(a => `<option value="${a}">${a}</option>`).join("");
      if (anni.includes(Number(current))) fAnno.value = current;
    }

    async function loadByFilters(){
      const prod = fProduttore.value;
      const comp = fCompagnia.value;
      const tipo = fTipoPolizza.value;
      const inc = fIncentivazione.value;

      const pagateSel = fPagate.value; // PATCH: "", "true", "false"

      const annoSel = fAnno.value ? Number(fAnno.value) : null;
      const meseSel = fMese.value ? Number(fMese.value) : null;

      try{
        const ref = collection(db, COL_EXTRA);
        const constraints = [];

        if (prod) constraints.push(where("produttore", "==", prod));
        if (comp) constraints.push(where("compagnia", "==", comp));
        if (tipo) constraints.push(where("tipoPolizza", "==", tipo));
        if (inc) constraints.push(where("incentivazione", "==", inc));

        // PATCH: filtro pagate
        if (pagateSel !== "") {
          constraints.push(where("pagate", "==", pagateSel === "true"));
        }

        if (annoSel) constraints.push(where("anno", "==", annoSel));
        if (meseSel) constraints.push(where("mese", "==", meseSel));

        constraints.push(orderBy("dataiso", "desc"));

        const q = query(ref, ...constraints);
        const snap = await getDocs(q);

        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderResults(rows);
      }catch(e){
        console.error(e);
        setMsg("err", `Errore query.\n${e.code || ""} ${e.message || ""}`);
      }
    }

    btnApplicaFiltri.addEventListener("click", loadByFilters);

    tbody.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!action || !id) return;

      if (action === "del"){
        if (!confirm("Confermi eliminazione?")) return;
        try{
          await deleteDoc(doc(db, COL_EXTRA, id));
          await loadByFilters();
        }catch(e){
          console.error(e);
          setMsg("err", `Errore eliminazione.\n${e.code || ""} ${e.message || ""}`);
        }
      }

      if (action === "edit"){
        const row = lastResults.find(r => r.id === id);
        if (!row) return;

        const nuovoImponibile = prompt("Nuovo premio imponibile:", String(row.premioImponibile ?? ""));
        if (nuovoImponibile === null) return;

        const nuovaPerc = prompt("Nuova percentuale:", String(row.percentuale ?? ""));
        if (nuovaPerc === null) return;

        const imponibileVal = toNumber(nuovoImponibile);
        const percVal = toNumber(nuovaPerc);
        if (!Number.isFinite(imponibileVal) || !Number.isFinite(percVal)){
          setMsg("err","Valori non validi.");
          return;
        }

        const provvVal = Math.round((imponibileVal * (percVal/100)) * 100)/100;

        try{
          await updateDoc(doc(db, COL_EXTRA, id), {
            premioImponibile: imponibileVal,
            percentuale: percVal,
            provvigioni: provvVal,
            updatedAt: serverTimestamp()
          });
          await loadByFilters();
        }catch(e){
          console.error(e);
          setMsg("err", `Errore modifica.\n${e.code || ""} ${e.message || ""}`);
        }
      }
    });

    tbody.addEventListener("change", async (ev) => {
      const el = ev.target;
      const action = el.dataset.action;
      const id = el.dataset.id;
      if (!action || !id) return;

      if (action === "togglePaid"){
        const checked = el.checked;
        const dateInput = tbody.querySelector(`input[data-action="paidDate"][data-id="${id}"]`);
        if (dateInput){
          dateInput.disabled = !checked;
          if (checked && !dateInput.value){
            const d = new Date();
            dateInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          }
          if (!checked) dateInput.value = "";
        }

        try{
          await updateDoc(doc(db, COL_EXTRA, id), {
            pagate: checked,
            pagateData: checked ? (dateInput ? dateInput.value : null) : null,
            updatedAt: serverTimestamp()
          });
        }catch(e){
          console.error(e);
          setMsg("err", `Errore aggiornamento pagate.\n${e.code || ""} ${e.message || ""}`);
        }
      }

      if (action === "paidDate"){
        const val = el.value || null;
        try{
          await updateDoc(doc(db, COL_EXTRA, id), {
            pagateData: val,
            pagate: !!val,
            updatedAt: serverTimestamp()
          });
          const cb = tbody.querySelector(`input[data-action="togglePaid"][data-id="${id}"]`);
          if (cb) cb.checked = !!val;
        }catch(e){
          console.error(e);
          setMsg("err", `Errore aggiornamento data pagate.\n${e.code || ""} ${e.message || ""}`);
        }
      }
    });

    function exportExcel(){
      if (!window.XLSX) return;

      const data = lastResults.map(r => ({
        Data: r.dataiso ?? "",
        Titolo: r.titolo ?? "",
        Produttore: r.produttore ?? "",
        Compagnia: r.compagnia ?? "",
        Tipo: r.tipoPolizza ?? "",
        Incentivazione: r.incentivazione ?? "",
        Polizza: r.numeroPolizza ?? "",
        Premio: Number(r.premio ?? 0),
        "Premio imponibile": Number(r.premioImponibile ?? 0),
        "Percentuale %": Number(r.percentuale ?? 0),
        Provvigioni: Number(r.provvigioni ?? 0),
        Pagate: r.pagate ? "SI" : "NO",
        "Data pagate": r.pagateData ?? "",
        Anno: r.anno ?? "",
        Mese: r.mese ?? ""
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Selezione");

      const prod = fProduttore.value || "Tutti";
      const comp = fCompagnia.value || "Tutte";
      const tipo = fTipoPolizza.value || "Tutti";
      const inc = fIncentivazione.value || "Tutte";
      const pag = fPagate.value === "" ? "Tutte" : (fPagate.value === "true" ? "Pagate" : "DaPagare");
      const anno = fAnno.value || "Tutti";
      const mese = fMese.value || "Tutti";

      XLSX.writeFile(wb, `ProvvigioniExtra_${prod}_${comp}_${tipo}_${inc}_${pag}_A${anno}_M${mese}.xlsx`);
    }
    btnExportExcel.addEventListener("click", exportExcel);

    async function init(){
      await loadProduttori();
      await loadIncentivazioni();
      await loadByFilters();
      setMsg("ok", "Pronto.");
    }
    init();
  </script>
</body>
</html>
