<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Provvigioni Extra</title>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#070A12">

<link rel="icon" type="image/svg+xml" href="icon.svg">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <style>
    :root{
      --bg:#070A12;
      --text:#EAF0FF;
      --muted:#9AA6C0;
      --line: rgba(120, 150, 255, .18);
      --danger:#FF5A7A;
      --ok:#35F2A6;
      --warn:#FFC04D;
      --glow-orange: #FF6B00; 
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:26px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(255, 107, 0, .08), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(177,140,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #050711);
      color: var(--text);
    }
    .wrap{ max-width: 1200px; margin: 0 auto; }
    
    .title{ 
      display:flex; flex-direction: column; align-items:start; justify-content:center; 
      margin-bottom: 24px; gap: 10px;
    }
    .title h1{ 
      margin:0; font-size: 38px; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; color: #fff;
      text-shadow: 0 0 10px rgba(255, 107, 0, 0.6), 0 0 20px rgba(255, 107, 0, 0.4);
    }
    .badge{
      padding:6px 12px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); border-radius: 999px;
      color: var(--muted); font-size: 12px;
    }
    
    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius: 14px; padding: 20px;
      box-shadow: 0 0 0 1px rgba(124,246,255,.08), 0 18px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    label{ display:block; margin: 10px 0 6px; color: var(--muted); font-size: 13px; }
    input, select, button{
      width:100%; padding: 11px 12px; border-radius: 12px;
      border: 1px solid rgba(120,150,255,.22);
      background: rgba(10, 14, 28, .85); color: var(--text);
      outline: none; transition: all 0.2s ease;
    }
    input:focus, select:focus{
      border-color: var(--glow-orange); box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.15);
    }
    input[readonly]{ background: rgba(255,255,255,.04); border-style: dashed; color: rgba(234,240,255,.92); }
    
    .grid{ display:grid; grid-template-columns: 1.1fr 1fr; gap: 20px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .split{ display:flex; gap:10px; flex-wrap: wrap; align-items: end; }
    .split > *{ flex: 1; min-width: 180px; }

    .actions{ display:flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; align-items:center; }
    .btn{
      width:auto; padding: 12px 20px; cursor:pointer; white-space: nowrap;
      border: 1px solid rgba(124,246,255,.35);
      background: linear-gradient(180deg, rgba(124,246,255,.12), rgba(177,140,255,.10));
      box-shadow: 0 0 18px rgba(124,246,255,.14); font-weight: 600;
    }
    .btn#btnInserisci {
      border-color: var(--glow-orange);
      background: linear-gradient(180deg, rgba(255, 107, 0, 0.15), rgba(255, 107, 0, 0.05));
      box-shadow: 0 0 20px rgba(255, 107, 0, 0.2); color: #fff;
    }
    .btn#btnInserisci:hover { background: rgba(255, 107, 0, 0.25); }
    .btn.secondary{ border-color: rgba(177,140,255,.35); background: rgba(255,255,255,.03); font-weight: normal; }
    .btn.danger{ border-color: rgba(255,90,122,.45); background: rgba(255,90,122,.08); }
    .btn.warn{ border-color: rgba(255,192,77,.45); background: rgba(255,192,77,.08); }
    
    .msg{ margin-top: 10px; font-size: 13px; color: var(--muted); white-space: pre-wrap; }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--danger); }

    .toolbar{
      display:flex; gap: 10px; flex-wrap: wrap; align-items: end;
      margin-top: 20px; padding: 16px; border-radius: 14px;
      border: 1px solid var(--line); background: rgba(255,255,255,.02);
    }
    .tool{ min-width: 170px; flex: 1; }
    .tool.small{ min-width: 130px; max-width: 190px; flex: 0; }

    table{
      width:100%; border-collapse: collapse; margin-top: 16px;
      overflow:hidden; border-radius: 14px;
      border: 1px solid var(--line); background: rgba(6, 9, 18, .6);
    }
    th, td{ padding: 12px 12px; border-bottom: 1px solid rgba(120,150,255,.14); font-size: 13px; vertical-align: middle; }
    th{ text-align:left; color: rgba(234,240,255,.95); background: rgba(255,255,255,.03); font-weight: 600; }
    tr:hover td{ background: rgba(124,246,255,.04); }
    .mono{ font-variant-numeric: tabular-nums; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius: 999px;
      border:1px solid rgba(120,150,255,.22); background: rgba(255,255,255,.02);
    }
    .cell-actions{ display:flex; gap:8px; flex-wrap: wrap; }
    .tiny{ width:auto; padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .paid-wrap{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .hidden{ display:none !important; }

    /* MODALE */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
      z-index: 1000; display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: #0D111D; border: 1px solid var(--glow-orange);
      border-radius: 16px; padding: 24px; width: 100%; max-width: 800px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: 0 0 40px rgba(255, 107, 0, 0.2);
    }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--glow-orange); text-transform: uppercase; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>Provvigioni Extra</h1>
      <div class="badge">Produttori + Incentivazioni dinamiche · Firestore</div>
    </div>

    <div class="card">
      <form id="formProvvigioni">
        <div class="grid">
          <div>
            <div class="split">
              <div>
                <label for="nomeCliente">Nome Cliente</label>
                <input id="nomeCliente" type="text" placeholder="Es. Mario Rossi" />
              </div>
              <div>
                <label for="dataDecorrenza">Data Decorrenza</label>
                <input id="dataDecorrenza" type="date" />
              </div>
            </div>

            <div class="split">
              <div>
                <label for="produttoreSelect">Produttore</label>
                <select id="produttoreSelect" required>
                  <option value="" selected disabled>Caricamento...</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn secondary" type="button" id="btnNuovoProduttore">Nuovo produttore</button>
              </div>
            </div>

            <div class="split">
              <div>
                <label for="compagniaSelect">Compagnia</label>
                <select id="compagniaSelect" required>
                  <option value="" selected disabled>Seleziona...</option>
                  <option value="ALLIANZ">ALLIANZ</option>
                  <option value="HDI">HDI</option>
                  <option value="VITTORIA">VITTORIA</option>
                  <option value="ARAG">ARAG</option>
                  <option value="HELVETIA">HELVETIA</option>
                  <option value="GENIALPIU'">GENIALPIU'</option>
                  <option value="METLIFE">METLIFE</option>
                </select>
              </div>

              <div>
                <label for="tipoPolizzaSelect">Tipo polizza</label>
                <select id="tipoPolizzaSelect" required>
                  <option value="" selected disabled>Seleziona...</option>
                  <option value="NUOVA">Polizza nuova</option>
                  <option value="SOSTITUZIONE_AUMENTO">Sostituzione (premio in aumento)</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div>
                <label for="incentivazioneSelect">Incentivazione</label>
                <select id="incentivazioneSelect" required>
                  <option value="" selected disabled>Caricamento...</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn secondary" type="button" id="btnNuovaIncentivazione">Nuova incentivazione</button>
              </div>
            </div>

            <label for="numeroPolizza">Numero di polizza</label>
            <input id="numeroPolizza" type="text" required placeholder="Es. 123456789" />
          </div>

          <div>
            <div class="row2">
              <div>
                <label for="premio">Premio</label>
                <input id="premio" type="number" step="0.01" min="0" required placeholder="0,00" />
              </div>
              <div>
                <label for="premioImponibile">Premio imponibile</label>
                <input id="premioImponibile" type="number" step="0.01" min="0" required placeholder="0,00" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label for="percentuale">% provvigioni (su imponibile)</label>
                <input id="percentuale" type="number" step="0.01" min="0" required placeholder="Es. 12,50" />
              </div>
              <div>
                <label for="provvigioni">Provvigioni calcolate</label>
                <input id="provvigioni" type="number" step="0.01" readonly placeholder="0,00" />
              </div>
            </div>

            <div class="actions">
              <button class="btn" type="button" id="btnInserisci">INSERISCI E SALVA</button>
              <button class="btn secondary" type="reset" id="btnReset">Reset</button>
            </div>
            <div id="msg" class="msg"></div>
          </div>
        </div>
      </form>

      <div class="toolbar">
        <div class="tool">
          <label for="fProduttore">Filtro produttore</label>
          <select id="fProduttore"><option value="">Tutti</option></select>
        </div>
<div class="tool small">
  <label>Gestione Dati</label>
  <div style="display:flex; gap:5px;">
    <button class="btn secondary" type="button" id="btnBackupDownload" title="Scarica Backup JSON">Backup</button>
    <button class="btn warn" type="button" id="btnBackupRestore" title="Carica Backup JSON">Ripristina</button>
  </div>
  <input type="file" id="fileBackupInput" accept=".json" class="hidden" />
</div>
        <div class="tool">
          <label for="fCompagnia">Compagnia</label>
          <select id="fCompagnia">
            <option value="">Tutte</option>
            <option value="ALLIANZ">ALLIANZ</option>
            <option value="HDI">HDI</option>
            <option value="VITTORIA">VITTORIA</option>
            <option value="ARAG">ARAG</option>
            <option value="HELVETIA">HELVETIA</option>
            <option value="GENIALPIU'">GENIALPIU'</option>
            <option value="METLIFE">METLIFE</option>
          </select>
        </div>
        <div class="tool">
          <label for="fTipoPolizza">Tipo polizza</label>
          <select id="fTipoPolizza">
            <option value="">Tutti</option>
            <option value="NUOVA">Polizza nuova</option>
            <option value="SOSTITUZIONE_AUMENTO">Sostituzione</option>
          </select>
        </div>
        <div class="tool">
          <label for="fIncentivazione">Incentivazione</label>
          <select id="fIncentivazione"><option value="">Tutte</option></select>
        </div>
        <div class="tool small">
          <label for="fPagate">Pagamenti</label>
          <select id="fPagate">
            <option value="">Tutte</option>
            <option value="true">Pagate</option>
            <option value="false">Da pagare</option>
          </select>
        </div>
        <div class="tool small">
          <label for="fAnno">Anno</label>
          <select id="fAnno"><option value="">Tutti</option></select>
        </div>
        <div class="tool small">
          <label for="fMese">Mese</label>
          <select id="fMese">
            <option value="">Tutti</option>
            <option value="1">Gen</option><option value="2">Feb</option><option value="3">Mar</option>
            <option value="4">Apr</option><option value="5">Mag</option><option value="6">Giu</option>
            <option value="7">Lug</option><option value="8">Ago</option><option value="9">Set</option>
            <option value="10">Ott</option><option value="11">Nov</option><option value="12">Dic</option>
          </select>
        </div>
        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnApplicaFiltri">Applica</button>
        </div>
        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnExportExcel">Export Excel</button>
        </div>
      </div>

      <table id="tabella" class="hidden">
        <thead>
          <tr>
            <th>Data Ins.</th>
            <th>Cliente</th>
            <th>Decorrenza</th>
            <th>Produttore</th>
            <th>Compagnia</th>
            <th>Tipo</th>
            <th>Polizza</th>
            <th class="mono">Provv.</th>
            <th>Pagate</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="totaleBox" class="msg"></div>
    </div>
  </div>

  <div id="editModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">Modifica Provvigione</div>
      <form id="formEdit">
        <input type="hidden" id="editId" />
        <div class="grid">
          <div>
            <div class="split">
              <div>
                <label>Nome Cliente</label>
                <input id="editNomeCliente" type="text" />
              </div>
              <div>
                <label>Data Decorrenza</label>
                <input id="editDataDecorrenza" type="date" />
              </div>
            </div>
            <div class="split">
              <div>
                <label>Produttore</label>
                <select id="editProduttoreSelect"></select>
              </div>
              <div>
                <label>Compagnia</label>
                <select id="editCompagniaSelect">
                   <option value="ALLIANZ">ALLIANZ</option>
                   <option value="HDI">HDI</option>
                   <option value="VITTORIA">VITTORIA</option>
                   <option value="ARAG">ARAG</option>
                   <option value="HELVETIA">HELVETIA</option>
                   <option value="GENIALPIU'">GENIALPIU'</option>
                   <option value="METLIFE">METLIFE</option>
                </select>
              </div>
            </div>
            <div class="split">
               <div>
                 <label>Tipo Polizza</label>
                 <select id="editTipoPolizzaSelect">
                    <option value="NUOVA">Polizza nuova</option>
                    <option value="SOSTITUZIONE_AUMENTO">Sostituzione</option>
                 </select>
               </div>
               <div>
                 <label>Incentivazione</label>
                 <select id="editIncentivazioneSelect"></select>
               </div>
            </div>
            <label>Numero Polizza</label>
            <input id="editNumeroPolizza" type="text" />
          </div>
          <div>
            <div class="row2">
              <div>
                <label>Premio</label>
                <input id="editPremio" type="number" step="0.01" />
              </div>
              <div>
                <label>Premio Imponibile</label>
                <input id="editPremioImponibile" type="number" step="0.01" />
              </div>
            </div>
            <div class="row2">
              <div>
                <label>% Provvigione</label>
                <input id="editPercentuale" type="number" step="0.01" />
              </div>
              <div>
                <label>Calcolo Provv.</label>
                <input id="editProvvigioni" type="number" step="0.01" readonly />
              </div>
            </div>
            <div class="actions" style="margin-top:24px;">
              <button class="btn" type="button" id="btnSalvaModifiche">SALVA MODIFICHE</button>
              <button class="btn secondary" type="button" id="btnChiudiModal">Annulla</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, setDoc,
      query, where, orderBy, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBImpElnjCpYyMMrNh63xJDJ89Vxf3DIc",
      authDomain: "provvigioni-extra-allianz.firebaseapp.com",
      projectId: "provvigioni-extra-allianz",
      storageBucket: "provvigioni-extra-allianz.firebasestorage.app",
      messagingSenderId: "650627729378",
      appId: "1:650627729378:web:3e91c2a09dd071437c5bbb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const COL_EXTRA = "allianz_provvigioni_extra";
    const COL_PROD = "produttori";
    const COL_INC = "incentivazioni";

    const DEFAULT_PRODUTTORI = ["EVAN SGARBI","DUILIO FRARACCI","GINO POLIGANI","GIOVANNI CARERI","LUCA IORI","ANTONIO SENTIMENTI"];
    const DEFAULT_INCENTIVAZIONI = ["STANDARD"];

    // Main Form Elements
    const nomeClienteInput = document.getElementById("nomeCliente");
    const dataDecorrenzaInput = document.getElementById("dataDecorrenza");
    const produttoreSelect = document.getElementById("produttoreSelect");
    const btnNuovoProduttore = document.getElementById("btnNuovoProduttore");
    const compagniaSelect = document.getElementById("compagniaSelect");
    const tipoPolizzaSelect = document.getElementById("tipoPolizzaSelect");
    const incentivazioneSelect = document.getElementById("incentivazioneSelect");
    const btnNuovaIncentivazione = document.getElementById("btnNuovaIncentivazione");
    const numeroPolizza = document.getElementById("numeroPolizza");
    const premio = document.getElementById("premio");
    const premioImponibile = document.getElementById("premioImponibile");
    const percentuale = document.getElementById("percentuale");
    const provvigioni = document.getElementById("provvigioni");
    const btnInserisci = document.getElementById("btnInserisci");
    const btnReset = document.getElementById("btnReset");
    const msg = document.getElementById("msg");

    // Filter Elements
    const fProduttore = document.getElementById("fProduttore");
    const fCompagnia = document.getElementById("fCompagnia");
    const fTipoPolizza = document.getElementById("fTipoPolizza");
    const fIncentivazione = document.getElementById("fIncentivazione");
    const fPagate = document.getElementById("fPagate");
    const fAnno = document.getElementById("fAnno");
    const fMese = document.getElementById("fMese");
    const btnApplicaFiltri = document.getElementById("btnApplicaFiltri");

    // Table & Export
    const tabella = document.getElementById("tabella");
    const tbody = tabella.querySelector("tbody");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const totaleBox = document.getElementById("totaleBox");

    // Modal Elements
    const editModal = document.getElementById("editModal");
    const btnChiudiModal = document.getElementById("btnChiudiModal");
    const btnSalvaModifiche = document.getElementById("btnSalvaModifiche");
    
    // Edit Form Elements
    const editId = document.getElementById("editId");
    const editNomeCliente = document.getElementById("editNomeCliente");
    const editDataDecorrenza = document.getElementById("editDataDecorrenza");
    const editProduttoreSelect = document.getElementById("editProduttoreSelect");
    const editCompagniaSelect = document.getElementById("editCompagniaSelect");
    const editTipoPolizzaSelect = document.getElementById("editTipoPolizzaSelect");
    const editIncentivazioneSelect = document.getElementById("editIncentivazioneSelect");
    const editNumeroPolizza = document.getElementById("editNumeroPolizza");
    const editPremio = document.getElementById("editPremio");
    const editPremioImponibile = document.getElementById("editPremioImponibile");
    const editPercentuale = document.getElementById("editPercentuale");
    const editProvvigioni = document.getElementById("editProvvigioni");

    let produttori = [];
    let incentivazioni = [];
    let producerColorMap = {};
    let lastResults = [];

    function setMsg(type, text){
      msg.className = "msg" + (type ? " " + type : "");
      msg.textContent = text || "";
    }

    function toNumber(v){
      if (typeof v !== "string") v = String(v ?? "");
      v = v.replace(",", ".").trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function money2(n){ return (Math.round(n * 100) / 100).toFixed(2); }
    function pad2(n){ return String(n).padStart(2, "0"); }
    function normalizeName(s){ return (s || "").trim().toUpperCase(); }

    function colorForProducer(name){
      const palette = ["#7CF6FF","#B18CFF","#35F2A6","#FFC04D","#FF5A7A","#7CFFB2","#6CA8FF","#E0A6FF"];
      let h = 0;
      for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) >>> 0;
      return palette[h % palette.length];
    }

    // Calcolo Form Principale
    function calcolaProvvigioni(){
      const imp = toNumber(premioImponibile.value);
      const perc = toNumber(percentuale.value);
      if (!Number.isFinite(imp) || !Number.isFinite(perc)) { provvigioni.value = ""; return; }
      provvigioni.value = money2(imp * (perc / 100));
    }
    premioImponibile.addEventListener("input", calcolaProvvigioni);
    percentuale.addEventListener("input", calcolaProvvigioni);

    // Calcolo Form Modale
    function calcolaProvvigioniModal(){
      const imp = toNumber(editPremioImponibile.value);
      const perc = toNumber(editPercentuale.value);
      if (!Number.isFinite(imp) || !Number.isFinite(perc)) { editProvvigioni.value = ""; return; }
      editProvvigioni.value = money2(imp * (perc / 100));
    }
    editPremioImponibile.addEventListener("input", calcolaProvvigioniModal);
    editPercentuale.addEventListener("input", calcolaProvvigioniModal);

    btnReset.addEventListener("click", () => {
      setMsg("", "");
      provvigioni.value = "";
    });

    function mergeList(defaults, firestoreList){
      const set = new Map();
      defaults.forEach(n => set.set(normalizeName(n), { id: null, name: normalizeName(n) }));
      firestoreList.forEach(p => set.set(normalizeName(p.name), { id: p.id || null, name: normalizeName(p.name) }));
      return [...set.values()].sort((a,b)=>a.name.localeCompare(b.name));
    }

    function renderProduttori(){
      const html = `<option value="" selected disabled>Seleziona...</option>` +
        produttori.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
      
      produttoreSelect.innerHTML = html;
      editProduttoreSelect.innerHTML = html; // Popolo anche il modal

      fProduttore.innerHTML = `<option value="">Tutti</option>` +
        produttori.map(p => `<option value="${p.name}">${p.name}</option>`).join("");

      producerColorMap = {};
      produttori.forEach(p => producerColorMap[p.name] = colorForProducer(p.name));
    }

    function renderIncentivazioni(){
      const html = `<option value="" selected disabled>Seleziona...</option>` +
        incentivazioni.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
      
      incentivazioneSelect.innerHTML = html;
      editIncentivazioneSelect.innerHTML = html; // Popolo anche il modal

      fIncentivazione.innerHTML = `<option value="">Tutte</option>` +
        incentivazioni.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
    }

    async function loadProduttori(){
      try{
        const ref = collection(db, COL_PROD);
        const q = query(ref, orderBy("name", "asc"));
        const snap = await getDocs(q);
        const fs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.name);
        produttori = mergeList(DEFAULT_PRODUTTORI, fs);
        renderProduttori();
      }catch(e){
        console.error(e);
        produttori = mergeList(DEFAULT_PRODUTTORI, []);
        renderProduttori();
        setMsg("err", "Errore lettura produttori.");
      }
    }

    async function loadIncentivazioni(){
      try{
        const ref = collection(db, COL_INC);
        const q = query(ref, orderBy("name", "asc"));
        const snap = await getDocs(q);
        const fs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.name);
        incentivazioni = mergeList(DEFAULT_INCENTIVAZIONI, fs);
        renderIncentivazioni();
      }catch(e){
        console.error(e);
        incentivazioni = mergeList(DEFAULT_INCENTIVAZIONI, []);
        renderIncentivazioni();
        setMsg("err", "Errore lettura incentivazioni.");
      }
    }

    btnNuovoProduttore.addEventListener("click", async () => {
      const name = prompt("Inserisci nome nuovo produttore:");
      if (!name) return;
      const clean = normalizeName(name);
      if (!clean) return;
      if (produttori.some(p => p.name === clean)) return setMsg("err", "Produttore già presente.");
      try{
        await addDoc(collection(db, COL_PROD), { name: clean, createdAt: serverTimestamp() });
        setMsg("ok", "Produttore salvato.");
        await loadProduttori();
        produttoreSelect.value = clean;
      }catch(e){ setMsg("err", e.message); }
    });

    btnNuovaIncentivazione.addEventListener("click", async () => {
      const name = prompt("Inserisci nuova incentivazione:");
      if (!name) return;
      const clean = normalizeName(name);
      if (!clean) return;
      if (incentivazioni.some(p => p.name === clean)) return setMsg("err", "Incentivazione già presente.");
      try{
        await addDoc(collection(db, COL_INC), { name: clean, createdAt: serverTimestamp() });
        setMsg("ok", "Incentivazione salvata.");
        await loadIncentivazioni();
        incentivazioneSelect.value = clean;
      }catch(e){ setMsg("err", e.message); }
    });

    async function addRecord(){
      setMsg("", "");
      const form = document.getElementById("formProvvigioni");
      if (!form.reportValidity()) return;
      calcolaProvvigioni();

      const d = new Date();
      const anno = d.getFullYear();
      const mese = d.getMonth() + 1;
      const dataiso = `${anno}-${pad2(mese)}-${pad2(d.getDate())}`;

      const record = {
        titolo: `PROVVIGIONI EXTRA - ${numeroPolizza.value}`,
        nomeCliente: nomeClienteInput.value.trim(),
        dataDecorrenza: dataDecorrenzaInput.value,
        produttore: produttoreSelect.value,
        compagnia: compagniaSelect.value,
        tipoPolizza: tipoPolizzaSelect.value,
        incentivazione: incentivazioneSelect.value,
        numeroPolizza: numeroPolizza.value.trim(),
        premio: toNumber(premio.value),
        premioImponibile: toNumber(premioImponibile.value),
        percentuale: toNumber(percentuale.value),
        provvigioni: toNumber(provvigioni.value),
        anno, mese, dataiso,
        pagate: false, pagateData: null,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db, COL_EXTRA), record);
        setMsg("ok", "Inserito e salvato.");
        form.reset();
        provvigioni.value = "";
        await loadByFilters();
      }catch(e){ setMsg("err", `Errore salvataggio: ${e.message}`); }
    }
    btnInserisci.addEventListener("click", addRecord);

    function renderResults(rows){
      lastResults = rows;
      tbody.innerHTML = rows.map(r => {
        const c = producerColorMap[r.produttore] || "#7CF6FF";
        const checked = r.pagate ? "checked" : "";
        const dateVal = (r.pagateData && typeof r.pagateData === "string") ? r.pagateData : "";
        const disabledDate = r.pagate ? "" : "disabled";
        const tipoTxt = r.tipoPolizza === "SOSTITUZIONE_AUMENTO" ? "Sostituzione" : r.tipoPolizza === "NUOVA" ? "Nuova" : r.tipoPolizza;
        
        return `
          <tr>
            <td class="mono" style="color:var(--muted); font-size:11px;">${r.dataiso ?? ""}</td>
            <td><b>${r.nomeCliente ?? ""}</b></td>
            <td>${r.dataDecorrenza ?? ""}</td>
            <td><span style="color:${c}">${r.produttore ?? ""}</span></td>
            <td>${r.compagnia ?? ""}</td>
            <td>${tipoTxt}</td>
            <td>${r.numeroPolizza ?? ""}</td>
            <td class="mono" style="font-weight:bold; color:#fff;">${money2(Number(r.provvigioni ?? 0))}</td>
            <td>
              <div class="paid-wrap">
                <input type="checkbox" data-action="togglePaid" data-id="${r.id}" ${checked} title="Pagato?" />
                <input type="date" data-action="paidDate" data-id="${r.id}" value="${dateVal}" ${disabledDate}/>
              </div>
            </td>
            <td>
              <div class="cell-actions">
                <button class="btn warn tiny" type="button" data-action="edit" data-id="${r.id}">Mod.</button>
                <button class="btn danger tiny" type="button" data-action="del" data-id="${r.id}">X</button>
              </div>
            </td>
          </tr>`;
      }).join("");

      tabella.classList.toggle("hidden", rows.length === 0);
      const totProvv = rows.reduce((s, r) => s + (Number(r.provvigioni)||0), 0);
      const totImp = rows.reduce((s, r) => s + (Number(r.premioImponibile)||0), 0);
      totaleBox.className = "msg ok";
      totaleBox.textContent = `Totale provvigioni: ${money2(totProvv)}\nTotale imponibile: ${money2(totImp)}`;
      
      const anni = [...new Set(rows.map(r => r.anno))].filter(Boolean).sort((a,b)=>b-a);
      if(fAnno.children.length<=1) 
        fAnno.innerHTML = `<option value="">Tutti</option>` + anni.map(a => `<option value="${a}">${a}</option>`).join("");
    }

    async function loadByFilters(){
      const constraints = [];
      if(fProduttore.value) constraints.push(where("produttore", "==", fProduttore.value));
      if(fCompagnia.value) constraints.push(where("compagnia", "==", fCompagnia.value));
      if(fTipoPolizza.value) constraints.push(where("tipoPolizza", "==", fTipoPolizza.value));
      if(fIncentivazione.value) constraints.push(where("incentivazione", "==", fIncentivazione.value));
      if(fPagate.value !== "") constraints.push(where("pagate", "==", fPagate.value === "true"));
      if(fAnno.value) constraints.push(where("anno", "==", Number(fAnno.value)));
      if(fMese.value) constraints.push(where("mese", "==", Number(fMese.value)));
      constraints.push(orderBy("dataiso", "desc"));
      
      try{
        const q = query(collection(db, COL_EXTRA), ...constraints);
        const snap = await getDocs(q);
        renderResults(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      }catch(e){ console.error(e); setMsg("err", "Errore caricamento dati."); }
    }
    btnApplicaFiltri.addEventListener("click", loadByFilters);

    // Gestione Tabella (Delete e Open Modal)
    tbody.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      
      if (action === "del"){
        if (!confirm("Eliminare definitivamente?")) return;
        await deleteDoc(doc(db, COL_EXTRA, id));
        loadByFilters();
      }

      if (action === "edit"){
        const row = lastResults.find(r => r.id === id);
        if(!row) return;

        // Riempi Modale
        editId.value = row.id;
        editNomeCliente.value = row.nomeCliente || "";
        editDataDecorrenza.value = row.dataDecorrenza || "";
        editProduttoreSelect.value = row.produttore || "";
        editCompagniaSelect.value = row.compagnia || "";
        editTipoPolizzaSelect.value = row.tipoPolizza || "";
        editIncentivazioneSelect.value = row.incentivazione || "";
        editNumeroPolizza.value = row.numeroPolizza || "";
        editPremio.value = row.premio || "";
        editPremioImponibile.value = row.premioImponibile || "";
        editPercentuale.value = row.percentuale || "";
        editProvvigioni.value = row.provvigioni || "";

        // Mostra modale
        editModal.classList.remove("hidden");
      }
    });

    // Gestione Chiusura/Salvataggio Modal
    btnChiudiModal.addEventListener("click", () => editModal.classList.add("hidden"));
    
    btnSalvaModifiche.addEventListener("click", async () => {
      const id = editId.value;
      if(!id) return;
      
      const imp = toNumber(editPremioImponibile.value);
      const perc = toNumber(editPercentuale.value);
      const prov = toNumber(editProvvigioni.value);

      try{
        await updateDoc(doc(db, COL_EXTRA, id), {
          nomeCliente: editNomeCliente.value.trim(),
          dataDecorrenza: editDataDecorrenza.value,
          produttore: editProduttoreSelect.value,
          compagnia: editCompagniaSelect.value,
          tipoPolizza: editTipoPolizzaSelect.value,
          incentivazione: editIncentivazioneSelect.value,
          numeroPolizza: editNumeroPolizza.value.trim(),
          premio: toNumber(editPremio.value),
          premioImponibile: imp,
          percentuale: perc,
          provvigioni: prov,
          updatedAt: serverTimestamp()
        });
        editModal.classList.add("hidden");
        await loadByFilters();
        setMsg("ok", "Modifica salvata.");
      }catch(e){
        alert("Errore salvataggio modifica: " + e.message);
      }
    });

    // Toggle Paid Checkbox
    tbody.addEventListener("change", async (ev) => {
      const el = ev.target;
      const action = el.dataset.action;
      const id = el.dataset.id;
      if (!action || !id) return;
      
      if (action === "togglePaid"){
        const checked = el.checked;
        const dateInput = tbody.querySelector(`input[data-action="paidDate"][data-id="${id}"]`);
        if(dateInput){
            dateInput.disabled = !checked;
            if(checked && !dateInput.value){
                const d = new Date();
                dateInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            }
            if(!checked) dateInput.value = "";
        }
        await updateDoc(doc(db, COL_EXTRA, id), {
            pagate: checked, 
            pagateData: checked ? dateInput.value : null, 
            updatedAt: serverTimestamp()
        });
      }
      if (action === "paidDate"){
        const val = el.value;
        await updateDoc(doc(db, COL_EXTRA, id), { pagateData: val, pagate: !!val });
      }
    });

    btnExportExcel.addEventListener("click", () => {
      if (!window.XLSX) return;
      const data = lastResults.map(r => ({
        "Data Ins.": r.dataiso, "Cliente": r.nomeCliente, "Decorrenza": r.dataDecorrenza,
        "Produttore": r.produttore, "Compagnia": r.compagnia, "Tipo": r.tipoPolizza,
        "Incentivazione": r.incentivazione, "Polizza": r.numeroPolizza,
        "Premio": r.premio, "Imponibile": r.premioImponibile, "%": r.percentuale,
        "Provvigioni": r.provvigioni, "Pagate": r.pagate?"SI":"NO", "Data Pag.": r.pagateData
      }));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Export");
      XLSX.writeFile(wb, `Provvigioni_${new Date().getTime()}.xlsx`);
    });

    async function init(){
      await loadProduttori();
      await loadIncentivazioni();
      await loadByFilters();
    }
// ==========================================
    // SEZIONE BACKUP E RIPRISTINO
    // ==========================================

    const btnBackupDownload = document.getElementById("btnBackupDownload");
    const btnBackupRestore = document.getElementById("btnBackupRestore");
    const fileBackupInput = document.getElementById("fileBackupInput");

    // Helper per scaricare dati massivi
    async function getFullCollection(colName) {
      const q = query(collection(db, colName));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ _id: d.id, ...d.data() }));
    }

    // 1. ESPORTAZIONE (BACKUP)
    btnBackupDownload.addEventListener("click", async () => {
      if(!confirm("Vuoi scaricare un backup completo di tutti i dati (JSON)?")) return;
      
      try {
        setMsg("warn", "Generazione backup in corso...");
        
        // Scarica tutto in parallelo
        const [prodData, incData, extraData] = await Promise.all([
          getFullCollection(COL_PROD),
          getFullCollection(COL_INC),
          getFullCollection(COL_EXTRA)
        ]);

        const backupBundle = {
          version: 1,
          timestamp: new Date().toISOString(),
          stats: {
            produttori: prodData.length,
            incentivazioni: incData.length,
            provvigioni: extraData.length
          },
          data: {
            produttori: prodData,
            incentivazioni: incData,
            extra: extraData
          }
        };

        const blob = new Blob([JSON.stringify(backupBundle, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement("a");
        a.href = url;
        a.download = `Backup_Provvigioni_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        setMsg("ok", `Backup scaricato con successo! (${extraData.length} provvigioni)`);
      } catch (e) {
        console.error(e);
        setMsg("err", "Errore durante il backup: " + e.message);
      }
    });

    // 2. RIPRISTINO (IMPORT) - Trigger
    btnBackupRestore.addEventListener("click", () => {
      fileBackupInput.value = ""; // Reset input
      fileBackupInput.click();
    });

    // Gestione file selezionato
    fileBackupInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const json = JSON.parse(event.target.result);
          
          // Validazione minima
          if (!json.data || !json.data.extra) {
            throw new Error("Formato file non valido.");
          }

          const countExtra = json.data.extra.length;
          const msgConfirm = `Trovati nel backup:\n` +
            `- ${json.data.produttori.length} Produttori\n` +
            `- ${json.data.incentivazioni.length} Incentivazioni\n` +
            `- ${countExtra} Provvigioni\n\n` +
            `ATTENZIONE: I dati con lo stesso ID verranno sovrascritti. Vuoi procedere?`;

          if (!confirm(msgConfirm)) return;

          setMsg("warn", "Ripristino in corso... attendere.");

          // Funzione per ripristinare una collezione
          const restoreCollection = async (colName, items) => {
            const promises = items.map(item => {
              const { _id, ...docData } = item;
              // Convertiamo eventuali stringhe data in Timestamp se necessario, 
              // ma Firestore accetta stringhe ISO o le lascia come stringhe.
              // Per sicurezza aggiorniamo updatedAt
              docData.updatedAt = serverTimestamp(); 
              return setDoc(doc(db, colName, _id), docData);
            });
            await Promise.all(promises);
          };

          // Esecuzione ripristino
          await restoreCollection(COL_PROD, json.data.produttori);
          await restoreCollection(COL_INC, json.data.incentivazioni);
          await restoreCollection(COL_EXTRA, json.data.extra);

          setMsg("ok", "Ripristino completato con successo!");
          
          // Ricarica le liste
          await loadProduttori();
          await loadIncentivazioni();
          await loadByFilters();

        } catch (err) {
          console.error(err);
          setMsg("err", "Errore nel file di backup: " + err.message);
        }
      };
      reader.readAsText(file);
    });
    init();
  </script>
</body>
</html>
