<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuova Produzione - Registro</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#070A12">

  <style>
    /* STILI BASE */
    :root{
      --bg:#070A12; --text:#EAF0FF; --muted:#9AA6C0; --line: rgba(120, 150, 255, .18);
      --danger:#FF5A7A; --ok:#35F2A6; --warn:#FFC04D; 
      --glow-orange: #FF6B00; --glow-blue: #00D4FF;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:26px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 20% 10%, rgba(0, 212, 255, .05), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(177,140,255,.08), transparent 60%),
                  linear-gradient(180deg, var(--bg), #050711);
      color: var(--text);
    }
    .wrap{ max-width: 1300px; margin: 0 auto; }
    
    /* TITOLO GLOW ARANCIO FLUO */
    .title{ display:flex; flex-direction: column; margin-bottom: 30px; align-items: flex-start; gap: 10px; }
    .title h1{ 
      margin:0; font-size: 32px; text-transform: uppercase; font-weight: 900; letter-spacing: 2px; 
      color: #fff; 
      border: 3px solid var(--glow-orange);
      padding: 12px 24px;
      border-radius: 8px;
      background: rgba(255, 107, 0, 0.05);
      box-shadow: 0 0 15px rgba(255, 107, 0, 0.4), inset 0 0 15px rgba(255, 107, 0, 0.1);
      text-shadow: 2px 2px 0px #b34b00, 0 0 20px var(--glow-orange);
    }
    .badge{ margin-top:5px; padding:6px 12px; border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius: 999px; color: var(--muted); font-size: 12px; display:inline-block; width:fit-content;}
    
    .card{ border: 1px solid var(--line); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border-radius: 14px; padding: 20px; backdrop-filter: blur(8px); }
    
    label{ display:block; margin: 10px 0 6px; color: var(--muted); font-size: 13px; }
    input, select, button{ width:100%; padding: 11px 12px; border-radius: 12px; border: 1px solid rgba(120,150,255,.22); background: rgba(10, 14, 28, .85); color: var(--text); outline: none; transition: all 0.2s ease; }
    input:focus, select:focus{ border-color: var(--glow-blue); box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15); }
    input[readonly]{ background: rgba(255,255,255,.04); border-style: dashed; color: rgba(234,240,255,.92); }
    
    .grid{ display:grid; grid-template-columns: 1.1fr 1fr; gap: 20px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .split{ display:flex; gap:10px; flex-wrap: wrap; align-items: end; }
    .split > *{ flex: 1; min-width: 180px; }

    /* SEZIONE INCENTIVI SPECIALI */
    .incentive-box {
      border: 1px solid rgba(255, 192, 77, 0.3);
      background: rgba(255, 192, 77, 0.03);
      padding: 15px; border-radius: 12px; margin-top: 15px;
      transition: all 0.3s ease;
    }
    .incentive-box.hidden { display:none; }

    .actions{ display:flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; align-items:center; }
    .btn{ width:auto; padding: 12px 20px; cursor:pointer; border: 1px solid rgba(124,246,255,.35); background: linear-gradient(180deg, rgba(124,246,255,.12), rgba(177,140,255,.10)); font-weight: 600; color: #fff; }
    .btn#btnInserisci { border-color: var(--glow-blue); background: linear-gradient(180deg, rgba(0, 212, 255, 0.15), rgba(0, 212, 255, 0.05)); }
    .btn.secondary{ border-color: rgba(177,140,255,.35); background: rgba(255,255,255,.03); font-weight: normal; }
    .btn.danger{ border-color: rgba(255,90,122,.45); background: rgba(255,90,122,.08); }
    .btn.warn{ border-color: rgba(255,192,77,.45); background: rgba(255,192,77,.08); }
    
    .msg{ margin-top: 10px; font-size: 13px; color: var(--muted); white-space: pre-wrap; }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--danger); }

    .toolbar{ display:flex; gap: 10px; flex-wrap: wrap; align-items: end; margin-top: 20px; padding: 16px; border-radius: 14px; border: 1px solid var(--line); background: rgba(255,255,255,.02); }
    .tool{ min-width: 120px; flex: 1; }
    .tool.small{ min-width: 90px; max-width: 130px; flex: 0; }
    .tool.medium{ min-width: 110px; max-width: 150px; flex: 0; }

    table{ width:100%; border-collapse: collapse; margin-top: 16px; overflow:hidden; border-radius: 14px; border: 1px solid var(--line); background: rgba(6, 9, 18, .6); }
    th, td{ padding: 12px 12px; border-bottom: 1px solid rgba(120,150,255,.14); font-size: 13px; vertical-align: middle; }
    th{ text-align:left; color: rgba(234,240,255,.95); background: rgba(255,255,255,.03); font-weight: 600; }
    .mono{ font-variant-numeric: tabular-nums; }
    .cell-actions{ display:flex; gap:8px; flex-wrap: wrap; }
    .tiny{ width:auto; padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .paid-wrap{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .hidden{ display:none !important; }

    /* LOGIN & USER BAR */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #050711; z-index: 2000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box {
      width: 100%; max-width: 400px; padding: 40px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--line);
      border-radius: 20px; text-align: center;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }
    .user-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding: 10px 20px;
      background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid var(--line);
    }
    .user-info { font-size: 14px; color: var(--ok); font-weight: bold; }
    .role-badge { 
      font-size: 10px; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; margin-left: 8px; 
      background: var(--muted); color: #000;
    }
    .role-badge.admin { background: var(--glow-orange); color: #fff; }

    /* MODALE */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: #0D111D; border: 1px solid var(--glow-blue); border-radius: 16px; padding: 24px; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 40px rgba(0, 212, 255, 0.2); }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--glow-blue); text-transform: uppercase; }
  </style>
</head>

<body>

  <div id="loginOverlay">
    <div class="login-box">
      <h2 style="color:white; margin-bottom:20px;">ACCESSO PRODUZIONE</h2>
      <input type="email" id="emailLogin" placeholder="Email" style="margin-bottom:10px;">
      <input type="password" id="passwordLogin" placeholder="Password" style="margin-bottom:20px;">
      <button id="btnLogin" class="btn" style="background: var(--glow-orange); color: white;">ACCEDI</button>
      <div id="loginMsg" class="msg err"></div>
    </div>
  </div>

  <div class="wrap hidden" id="mainApp">
    
    <div class="user-bar">
      <div>
        <span class="user-info" id="currentUserDisplay"></span>
        <span id="roleBadge" class="role-badge">User</span>
      </div>
      <button id="btnLogout" class="btn secondary tiny">Logout</button>
    </div>

    <div class="title">
      <h1>Nuova Produzione</h1>
      <div class="badge">Registro Polizze Nuove / Sostituzioni · Gestione Incentivi</div>
    </div>

    <div class="card">
      <form id="formProvvigioni">
        <div class="grid">
          <div>
            <div class="split">
              <div>
                <label for="nomeCliente">Nome Cliente</label>
                <input id="nomeCliente" type="text" placeholder="Es. Mario Rossi" required />
              </div>
              <div>
                <label for="dataDecorrenza">Data Decorrenza</label>
                <input id="dataDecorrenza" type="date" required />
              </div>
            </div>

            <div class="split">
              <div>
                <label for="produttoreSelect">Produttore</label>
                <select id="produttoreSelect" required>
                  <option value="" selected disabled>Caricamento...</option>
                </select>
              </div>
              <div style="flex:0; min-width:auto;">
                 <label>&nbsp;</label>
                 <button class="btn secondary" type="button" id="btnNuovoProduttore" title="Aggiungi Produttore">+</button>
              </div>
              <div>
                <label for="compagniaSelect">Compagnia</label>
                <select id="compagniaSelect" required>
                  <option value="" selected disabled>Seleziona...</option>
                  <option value="ALLIANZ">ALLIANZ</option>
                  <option value="HDI">HDI</option>
                  <option value="VITTORIA">VITTORIA</option>
                  <option value="ARAG">ARAG</option>
                  <option value="HELVETIA">HELVETIA</option>
                  <option value="GENIALPIU'">GENIALPIU'</option>
                  <option value="METLIFE">METLIFE</option>
                </select>
              </div>
            </div>

            <div class="split">
  <div>
    <label for="tipoPolizzaSelect">Tipo polizza</label>
    <select id="tipoPolizzaSelect" required>
      <option value="" selected disabled>Seleziona...</option>
      <option value="NUOVA">Polizza Nuova Affari</option>
      <option value="SOSTITUZIONE_AUMENTO">Sostituzione (Aumento Premio)</option>
    </select>
  </div>
  <div>
    <label for="ramoSelect">Ramo</label>
    <select id="ramoSelect" required>
      <option value="" selected disabled>Seleziona...</option>
      <option value="MOTOR">Motor</option>
      <option value="RAMI VARI">Rami Vari</option>
      <option value="VITA">Vita</option>
    </select>
  </div>
  <div>
     <label for="numeroPolizza">Numero di polizza</label>
     <input id="numeroPolizza" type="text" required placeholder="Es. 123456789" />
  </div>
</div>
          </div>

          <div>
            <div class="row2">
              <div>
                <label for="premio">Premio Lordo Annuo (Opz)</label>
                <input id="premio" type="number" step="0.01" min="0" placeholder="0,00" />
              </div>
              <div>
                <label for="premioImponibile" style="color:#fff; font-weight:bold;">Premio Imponibile Annuo</label>
                <input id="premioImponibile" type="number" step="0.01" min="0" required placeholder="0,00" style="border-color:rgba(255,255,255,0.4);" />
              </div>
            </div>

            <div style="margin-top:15px; border-top:1px dashed var(--line); padding-top:10px;">
               <label for="toggleIncentivi" style="color:var(--warn);">Prevede Incentivazione Extra?</label>
               <select id="toggleIncentivi" style="margin-bottom:10px;">
                  <option value="NO">NO - Nessun incentivo extra</option>
                  <option value="SI">SI - Calcola provvigioni extra</option>
               </select>

               <div id="boxIncentivi" class="incentive-box hidden">
                  <div class="split">
                    <div>
                      <label for="incentivazioneSelect">Tipo Incentivazione</label>
                      <select id="incentivazioneSelect">
                        <option value="" selected disabled>Caricamento...</option>
                      </select>
                    </div>
                    <div>
                      <label>&nbsp;</label>
                      <button class="btn secondary" type="button" id="btnNuovaIncentivazione">Nuova Tipologia</button>
                    </div>
                  </div>

                  <div class="row2">
                    <div>
                      <label for="percentuale">% Extra (su imponibile)</label>
                      <input id="percentuale" type="number" step="0.01" min="0" placeholder="Es. 12,50" />
                    </div>
                    <div>
                      <label for="provvigioni">Importo Extra Calcolato</label>
                      <input id="provvigioni" type="number" step="0.01" readonly placeholder="0,00" />
                    </div>
                  </div>
               </div>
            </div>

            <div class="actions">
              <button class="btn" type="button" id="btnInserisci">REGISTRA POLIZZA</button>
              <button class="btn secondary" type="reset" id="btnReset">Pulisci</button>
            </div>
            <div id="msg" class="msg"></div>
          </div>
        </div>
      </form>

      <div class="toolbar">
        <div class="tool">
          <label for="fProduttore">Filtro produttore</label>
          <select id="fProduttore"><option value="">Tutti</option></select>
        </div>
        
        <div class="tool medium">
            <label for="fIncentivi">Incentivazione</label>
            <select id="fIncentivi">
                <option value="">Tutti</option>
                <option value="SI">SI (Con Extra)</option>
                <option value="NO">NO (Solo Polizza)</option>
            </select>
        </div>

        <div class="tool">
          <label for="fCompagnia">Compagnia</label>
          <select id="fCompagnia">
            <option value="">Tutte</option>
            <option value="ALLIANZ">ALLIANZ</option>
            <option value="HDI">HDI</option>
            <option value="VITTORIA">VITTORIA</option>
            <option value="ARAG">ARAG</option>
            <option value="HELVETIA">HELVETIA</option>
            <option value="GENIALPIU'">GENIALPIU'</option>
            <option value="METLIFE">METLIFE</option>
          </select>
        </div>

<div class="tool">
  <label for="fRamo">Ramo</label>
  <select id="fRamo">
    <option value="">Tutti</option>
    <option value="MOTOR">Motor</option>
    <option value="RAMI VARI">Rami Vari</option>
    <option value="VITA">Vita</option>
  </select>
</div>
<div class="tool small">
  <label for="fAnno">Anno Dec.</label>
  <select id="fAnno"><option value="">Tutti</option></select>
</div>

        <div class="tool small">
          <label for="fMese">Mese Dec.</label>
          <select id="fMese">
            <option value="">Tutti</option>
            <option value="1">Gennaio</option>
            <option value="2">Febbraio</option>
            <option value="3">Marzo</option>
            <option value="4">Aprile</option>
            <option value="5">Maggio</option>
            <option value="6">Giugno</option>
            <option value="7">Luglio</option>
            <option value="8">Agosto</option>
            <option value="9">Settembre</option>
            <option value="10">Ottobre</option>
            <option value="11">Novembre</option>
            <option value="12">Dicembre</option>
          </select>
        </div>

        <div class="tool small">
          <label for="fSettimana">Settimana</label>
          <select id="fSettimana">
             <option value="">Tutte</option>
             </select>
        </div>

        <div class="tool small">
          <label for="fPagate">Stato Inc.</label>
          <select id="fPagate">
            <option value="">Tutte</option>
            <option value="true">Pagate</option>
            <option value="false">Da pagare</option>
          </select>
        </div>
        
        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnApplicaFiltri">Applica</button>
        </div>
        <div class="tool small">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="btnExportExcel">Excel</button>
        </div>
         <div class="tool" style="min-width: 180px;">
          <label>Gestione Backup</label>
          <div style="display:flex; gap:5px;">
            <button class="btn secondary" type="button" id="btnBackupDownload">Salva</button>
            <button class="btn warn" type="button" id="btnBackupRestore">Carica</button>
          </div>
          <input type="file" id="fileBackupInput" accept=".json" class="hidden" />
        </div>
      </div>

      <table id="tabella" class="hidden">
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Polizza</th>
            <th>Comp./Prod.</th>
            <th>Ramo</th>
            <th>Premio Imp.</th>
            <th class="mono">Extra</th>
            <th>Incentivo</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="totaleBox" class="msg"></div>
    </div>
  </div>

  <div id="editModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">Modifica Polizza</div>
      <form id="formEdit">
        <input type="hidden" id="editId" />
        <div class="grid">
          <div>
            <div class="split">
              <div><label>Nome Cliente</label><input id="editNomeCliente" type="text" /></div>
              <div><label>Data Decorrenza</label><input id="editDataDecorrenza" type="date" /></div>
            </div>
            <div class="split">
              <div><label>Produttore</label><select id="editProduttoreSelect"></select></div>
              <div><label>Compagnia</label><select id="editCompagniaSelect">
                   <option value="ALLIANZ">ALLIANZ</option><option value="HDI">HDI</option>
                   <option value="VITTORIA">VITTORIA</option><option value="ARAG">ARAG</option>
                   <option value="HELVETIA">HELVETIA</option><option value="GENIALPIU'">GENIALPIU'</option>
                   <option value="METLIFE">METLIFE</option>
              </select></div>
            </div>
            <div class="split">
               <div><label>Tipo Polizza</label><select id="editTipoPolizzaSelect">
                    <option value="NUOVA">Nuova Affari</option><option value="SOSTITUZIONE_AUMENTO">Sostituzione</option>
               </select></div>
               <div><label>Numero Polizza</label><input id="editNumeroPolizza" type="text" /></div>
            </div>

<div class="split">
   <div>
     <label>Tipo Polizza</label>
     <select id="editTipoPolizzaSelect">
        <option value="NUOVA">Nuova Affari</option>
        <option value="SOSTITUZIONE_AUMENTO">Sostituzione</option>
     </select>
   </div>
   <div>
     <label>Ramo</label>
     <select id="editRamoSelect" required>
       <option value="MOTOR">Motor</option>
       <option value="RAMI VARI">Rami Vari</option>
       <option value="VITA">Vita</option>
     </select>
   </div>
   <div>
     <label>Numero Polizza</label>
     <input id="editNumeroPolizza" type="text" />
   </div>
</div>
  <div>
     <label for="numeroPolizza">Numero di polizza</label>
     <input id="numeroPolizza" type="text" required placeholder="Es. 123456789" />
  </div>
</div>
          </div>
          <div>
            <div class="row2">
              <div><label>Premio Lordo Annuo (Opz)</label><input id="editPremio" type="number" step="0.01" /></div>
              <div><label>Premio Imponibile Annuo</label><input id="editPremioImponibile" type="number" step="0.01" /></div>
            </div>

            <div style="margin-top:15px; border-top:1px dashed var(--line); padding-top:10px;">
                <label style="color:var(--warn);">Incentivazione Extra?</label>
                <select id="editToggleIncentivi" style="margin-bottom:10px;">
                  <option value="NO">NO</option>
                  <option value="SI">SI</option>
               </select>
               <div id="editBoxIncentivi" class="incentive-box hidden">
                 <div class="split">
                   <div><label>Tipo Incentivo</label><select id="editIncentivazioneSelect"></select></div>
                 </div>
                 <div class="row2">
                    <div><label>% Extra</label><input id="editPercentuale" type="number" step="0.01" /></div>
                    <div><label>Importo Extra</label><input id="editProvvigioni" type="number" step="0.01" readonly /></div>
                  </div>
               </div>
            </div>
            
            <div class="actions" style="margin-top:24px;">
              <button class="btn" type="button" id="btnSalvaModifiche">SALVA MODIFICHE</button>
              <button class="btn secondary" type="button" id="btnChiudiModal">Annulla</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    // IMPORT FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, setDoc,
      query, where, orderBy, getDocs, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    // CONFIGURAZIONE API KEY
    const firebaseConfig = {
      apiKey: "AIzaSyBImpEln_jCpYyMMrNh63xJDJ89Vxf3DIc",
      authDomain: "provvigioni-extra-allianz.firebaseapp.com",
      projectId: "provvigioni-extra-allianz",
      storageBucket: "provvigioni-extra-allianz.firebasestorage.app",
      messagingSenderId: "650627729378",
      appId: "1:650627729378:web:3e91c2a09dd071437c5bbb"
    };

    // LISTA ADMIN
    const ADMIN_EMAILS = [
      "evanesse1978@gmail.com", 
      "valentinavitr94@gmail.com",
      "luigi.vitrani@gmail.com",
      "assicurazioni.ams@gmail.com",
      "gino.poligani@gmail.com"
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const COL_EXTRA = "allianz_provvigioni_extra";
    const COL_PROD = "produttori";
    const COL_INC = "incentivazioni";

    let currentUser = null;
    let isAdmin = false;

    // Login UI
    const loginOverlay = document.getElementById("loginOverlay");
    const mainApp = document.getElementById("mainApp");
    const emailLogin = document.getElementById("emailLogin");
    const passwordLogin = document.getElementById("passwordLogin");
    const btnLogin = document.getElementById("btnLogin");
    const loginMsg = document.getElementById("loginMsg");
    const btnLogout = document.getElementById("btnLogout");
    const currentUserDisplay = document.getElementById("currentUserDisplay");
    const roleBadge = document.getElementById("roleBadge");

    // Main Form Elements
    const ramoSelect = document.getElementById("ramoSelect");
    const editRamoSelect = document.getElementById("editRamoSelect");
    const fRamo = document.getElementById("fRamo");
    const nomeClienteInput = document.getElementById("nomeCliente");
    const dataDecorrenzaInput = document.getElementById("dataDecorrenza");
    const produttoreSelect = document.getElementById("produttoreSelect");
    const btnNuovoProduttore = document.getElementById("btnNuovoProduttore");
    const compagniaSelect = document.getElementById("compagniaSelect");
    const tipoPolizzaSelect = document.getElementById("tipoPolizzaSelect");
    const numeroPolizza = document.getElementById("numeroPolizza");
    const premio = document.getElementById("premio");
    const premioImponibile = document.getElementById("premioImponibile");
    
    // Incentive Elements
    const toggleIncentivi = document.getElementById("toggleIncentivi");
    const boxIncentivi = document.getElementById("boxIncentivi");
    const incentivazioneSelect = document.getElementById("incentivazioneSelect");
    const btnNuovaIncentivazione = document.getElementById("btnNuovaIncentivazione");
    const percentuale = document.getElementById("percentuale");
    const provvigioni = document.getElementById("provvigioni");

    const btnInserisci = document.getElementById("btnInserisci");
    const btnReset = document.getElementById("btnReset");
    const msg = document.getElementById("msg");

    // Filters
    const fProduttore = document.getElementById("fProduttore");
    const fCompagnia = document.getElementById("fCompagnia");
    const fIncentivi = document.getElementById("fIncentivi");
    const fPagate = document.getElementById("fPagate");
    const fAnno = document.getElementById("fAnno");
    const fMese = document.getElementById("fMese"); 
    const fSettimana = document.getElementById("fSettimana"); // NUOVO
    const btnApplicaFiltri = document.getElementById("btnApplicaFiltri");

    // Table & Edit
    const tabella = document.getElementById("tabella");
    const tbody = tabella.querySelector("tbody");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const totaleBox = document.getElementById("totaleBox");
    const editModal = document.getElementById("editModal");
    const btnChiudiModal = document.getElementById("btnChiudiModal");
    const btnSalvaModifiche = document.getElementById("btnSalvaModifiche");

    // Edit Fields
    const editId = document.getElementById("editId");
    const editNomeCliente = document.getElementById("editNomeCliente");
    const editDataDecorrenza = document.getElementById("editDataDecorrenza");
    const editProduttoreSelect = document.getElementById("editProduttoreSelect");
    const editCompagniaSelect = document.getElementById("editCompagniaSelect");
    const editTipoPolizzaSelect = document.getElementById("editTipoPolizzaSelect");
    const editNumeroPolizza = document.getElementById("editNumeroPolizza");
    const editPremio = document.getElementById("editPremio");
    const editPremioImponibile = document.getElementById("editPremioImponibile");
    
    // Edit Incentive Fields
    const editToggleIncentivi = document.getElementById("editToggleIncentivi");
    const editBoxIncentivi = document.getElementById("editBoxIncentivi");
    const editIncentivazioneSelect = document.getElementById("editIncentivazioneSelect");
    const editPercentuale = document.getElementById("editPercentuale");
    const editProvvigioni = document.getElementById("editProvvigioni");
    
    // Variabili stato
    let produttori = [];
    let incentivazioni = [];
    let lastResults = [];
    let producerColorMap = {};

    // Populate Weeks
    (function popWeeks(){
        let html = '<option value="">Tutte</option>';
        for(let i=1; i<=53; i++) html += `<option value="${i}">Settimana ${i}</option>`;
        fSettimana.innerHTML = html;
    })();

    // Helper: ISO Week Number
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // ------------------------------------------------
    // GESTIONE AUTENTICAZIONE
    // ------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        isAdmin = ADMIN_EMAILS.includes(user.email);
        
        currentUserDisplay.textContent = user.email;
        roleBadge.textContent = isAdmin ? "AMMINISTRATORE" : "AGENTE";
        roleBadge.className = isAdmin ? "role-badge admin" : "role-badge";

        loginOverlay.classList.add("hidden");
        mainApp.classList.remove("hidden");

        const displayStyle = isAdmin ? "block" : "none";
        btnNuovoProduttore.style.display = displayStyle;
        btnNuovaIncentivazione.style.display = displayStyle;

        await init();
      } else {
        currentUser = null;
        isAdmin = false;
        loginOverlay.classList.remove("hidden");
        mainApp.classList.add("hidden");
      }
    });

    btnLogin.addEventListener("click", async () => {
      loginMsg.textContent = "";
      const email = emailLogin.value;
      const pwd = passwordLogin.value;
      try {
        await signInWithEmailAndPassword(auth, email, pwd);
      } catch(e) {
        loginMsg.textContent = "Errore login: " + e.message;
      }
    });

    btnLogout.addEventListener("click", () => signOut(auth));

    // ------------------------------------------------
    // LOGICA APP
    // ------------------------------------------------
    function setMsg(type, text){
      msg.className = "msg" + (type ? " " + type : "");
      msg.textContent = text || "";
    }
    function toNumber(v){
      if (typeof v !== "string") v = String(v ?? "");
      v = v.replace(",", ".").trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function money2(n){ return (Math.round(n * 100) / 100).toFixed(2); }
    function pad2(n){ return String(n).padStart(2, "0"); }
    function normalizeName(s){ return (s || "").trim().toUpperCase(); }
    function colorForProducer(name){
      const palette = ["#7CF6FF","#B18CFF","#35F2A6","#FFC04D","#FF5A7A","#7CFFB2","#6CA8FF"];
      let h = 0;
      for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) >>> 0;
      return palette[h % palette.length];
    }

    // TOGGLE INCENTIVI LOGIC
    function handleIncentiveToggle(toggleEl, boxEl, reqFields){
       const isSi = toggleEl.value === "SI";
       if(isSi){
         boxEl.classList.remove("hidden");
         reqFields.forEach(el => el.setAttribute("required", "true"));
       } else {
         boxEl.classList.add("hidden");
         reqFields.forEach(el => {
           el.removeAttribute("required");
           el.value = ""; 
         });
       }
    }

    toggleIncentivi.addEventListener("change", () => {
        handleIncentiveToggle(toggleIncentivi, boxIncentivi, [incentivazioneSelect, percentuale]);
        if(toggleIncentivi.value === "NO") provvigioni.value = "";
    });
    
    editToggleIncentivi.addEventListener("change", () => {
        handleIncentiveToggle(editToggleIncentivi, editBoxIncentivi, [editIncentivazioneSelect, editPercentuale]);
        if(editToggleIncentivi.value === "NO") editProvvigioni.value = "";
    });

    // Calcoli
    function calcola(impElem, percElem, outElem){
      const imp = toNumber(impElem.value);
      const perc = toNumber(percElem.value);
      if (imp <= 0 || perc <= 0) { outElem.value = ""; return; }
      outElem.value = money2(imp * (perc / 100));
    }
    premioImponibile.addEventListener("input", ()=>calcola(premioImponibile, percentuale, provvigioni));
    percentuale.addEventListener("input", ()=>calcola(premioImponibile, percentuale, provvigioni));
    
    editPremioImponibile.addEventListener("input", ()=>calcola(editPremioImponibile, editPercentuale, editProvvigioni));
    editPercentuale.addEventListener("input", ()=>calcola(editPremioImponibile, editPercentuale, editProvvigioni));

    btnReset.addEventListener("click", () => { 
        setMsg("",""); 
        provvigioni.value=""; 
        boxIncentivi.classList.add("hidden");
    });

    // Caricamento Dati Ausiliari
    async function loadAux(colName, selectIds){
      try{
        const q = query(collection(db, colName), orderBy("name", "asc"));
        const snap = await getDocs(q);
        const final = snap.docs.map(d => ({id:d.id, ...d.data()}));
        
        const html = `<option value="" selected disabled>Seleziona...</option>` +
          final.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
        
        selectIds.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.innerHTML = html;
        });
        
        if(colName === COL_PROD){
            produttori = final;
            fProduttore.innerHTML = `<option value="">Tutti</option>` + final.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
            producerColorMap={};
            final.forEach(p=>producerColorMap[p.name]=colorForProducer(p.name));
        }
      }catch(e){ console.error(e); }
    }

    btnNuovoProduttore.addEventListener("click", async () => {
      const name = prompt("Nome nuovo produttore:");
      if(!name) return;
      await addDoc(collection(db, COL_PROD), { name: normalizeName(name) });
      loadProduttori();
    });
    btnNuovaIncentivazione.addEventListener("click", async () => {
      const name = prompt("Nome nuova incentivazione:");
      if(!name) return;
      await addDoc(collection(db, COL_INC), { name: normalizeName(name) });
      loadIncentivazioni();
    });

    async function loadProduttori(){ loadAux(COL_PROD, ["produttoreSelect","editProduttoreSelect"]); }
    async function loadIncentivazioni(){ loadAux(COL_INC, ["incentivazioneSelect","editIncentivazioneSelect"]); }

    // SALVATAGGIO NUOVO RECORD
    async function addRecord(){
      if (!document.getElementById("formProvvigioni").reportValidity()) return;
      
      const d = new Date();
      const hasInc = toggleIncentivi.value === "SI";

      const record = {
async function addRecord(){
  if (!document.getElementById("formProvvigioni").reportValidity()) return;
  
  const d = new Date();
  const hasInc = toggleIncentivi.value === "SI";

  const record = {
    ramo: document.getElementById("ramoSelect").value, // INCOLLA QUESTA
    userId: currentUser.uid,
    userEmail: currentUser.email,
        ramo: ramoSelect.value,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        nomeCliente: nomeClienteInput.value.trim(),
        dataDecorrenza: dataDecorrenzaInput.value,
        produttore: produttoreSelect.value,
        compagnia: compagniaSelect.value,
        tipoPolizza: tipoPolizzaSelect.value,
        numeroPolizza: numeroPolizza.value.trim(),
        premio: toNumber(premio.value),
        premioImponibile: toNumber(premioImponibile.value),
        
        incentivazione: hasInc ? incentivazioneSelect.value : "NESSUNA",
        percentuale: hasInc ? toNumber(percentuale.value) : 0,
        provvigioni: hasInc ? toNumber(provvigioni.value) : 0,

        // Campi Legacy per ordinamento base
        anno: d.getFullYear(), mese: d.getMonth()+1,
        dataiso: `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`,
        pagate: false, pagateData: null,
        createdAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db, COL_EXTRA), record);
        setMsg("ok", "Polizza registrata con successo.");
        document.getElementById("formProvvigioni").reset();
        toggleIncentivi.value = "NO";
        boxIncentivi.classList.add("hidden");
        provvigioni.value = "";
        await loadByFilters();
      }catch(e){ setMsg("err", `Errore: ${e.message}`); }
    }
    btnInserisci.addEventListener("click", addRecord);

    // CARICAMENTO E FILTRI
    async function loadByFilters(){
      // QUERY BASE (Scarica tutto per l'utente, filtro poi in locale per flessibilità su date)
      let constraints = [];
      if (!isAdmin) constraints.push(where("userId", "==", currentUser.uid));
      // Filtri DB diretti solo per campi statici
      if(fProduttore.value) constraints.push(where("produttore", "==", fProduttore.value));
      if(fCompagnia.value) constraints.push(where("compagnia", "==", fCompagnia.value));
      if(fPagate.value !== "") constraints.push(where("pagate", "==", fPagate.value === "true"));
      
      constraints.push(orderBy("dataDecorrenza", "desc")); // Ordinamento per decorrenza
      
      try{
        const q = query(collection(db, COL_EXTRA), ...constraints);
        const snap = await getDocs(q);
        
        let results = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // ---- FILTRAGGIO LATO CLIENTE (Sulla Data Decorrenza) ----
        
        // Filtro ANNO (Decorrenza)
        if(fAnno.value) {
            results = results.filter(r => r.dataDecorrenza.startsWith(fAnno.value));
        }

        // Filtro MESE (Decorrenza)
        if(fMese.value) {
            results = results.filter(r => {
                const m = parseInt(r.dataDecorrenza.split("-")[1]);
                return m == fMese.value;
            });
        }

        // Filtro SETTIMANA (Decorrenza)
        if(fSettimana.value) {
            results = results.filter(r => {
                const dateObj = new Date(r.dataDecorrenza);
                const w = getWeekNumber(dateObj);
                return w == fSettimana.value;
            });
        }

// Filtro RAMO (Decorrenza)
if(fRamo && fRamo.value) {
    results = results.filter(r => r.ramo === fRamo.value);
}

        // Filtro INCENTIVI
        const fIncVal = fIncentivi.value;
        if(fIncVal === "SI"){
             results = results.filter(r => r.incentivazione !== "NESSUNA" && r.provvigioni > 0);
        } else if (fIncVal === "NO"){
             results = results.filter(r => r.incentivazione === "NESSUNA" || !r.provvigioni || r.provvigioni === 0);
        }

        renderResults(results);
      }catch(e){ 
        console.error(e); 
        setMsg("err", "Errore caricamento dati (Verifica Indici)."); 
      }
    }
    btnApplicaFiltri.addEventListener("click", loadByFilters);

    function renderResults(rows){
      lastResults = rows;
      tbody.innerHTML = rows.map(r => {
        const c = producerColorMap[r.produttore] || "#7CF6FF";
        const hasExtra = (r.provvigioni > 0 && r.incentivazione !== "NESSUNA");
        
        const extraClass = hasExtra ? "color:#fff;font-weight:bold" : "color:#555;";
        const extraVal = hasExtra ? money2(Number(r.provvigioni)) : "-";
        
        let statusHtml = "";
        if(hasExtra){
             const isPaid = r.pagate ? "checked" : "";
             const dateVal = (r.pagateData && typeof r.pagateData === "string") ? r.pagateData : "";
             const disabledDate = r.pagate ? "" : "disabled";
             const disableCheck = isAdmin ? "" : "disabled";
             
             statusHtml = `<div class="paid-wrap">
                <input type="checkbox" data-action="togglePaid" data-id="${r.id}" ${isPaid} ${disableCheck}>
                <input type="date" data-action="paidDate" data-id="${r.id}" value="${dateVal}" ${disabledDate} ${disableCheck} style="width:105px; padding:4px;">
               </div>`;
        } else {
             statusHtml = `<span style="opacity:0.3; font-size:11px;">-</span>`;
        }

        return `<tr>
    <td style="color:#999;font-size:11px">${r.dataDecorrenza||""}</td>
    <td><b>${r.nomeCliente||""}</b></td>
    <td>${r.numeroPolizza||""}<br><small>${r.tipoPolizza === 'NUOVA' ? 'Nuova' : 'Sost.'}</small></td>
    <td>${r.compagnia}<br><span style="color:${c}">${r.produttore}</span></td>
    <td>${r.ramo || "-"}</td>
    <td class="mono">${money2(r.premioImponibile||0)}</td>
    <td class="mono" style="${extraClass}">${extraVal}</td>
    <td><small>${r.incentivazione === "NESSUNA" ? "" : r.incentivazione}</small></td>
    <td>${statusHtml}</td>
    <td>
      <div class="cell-actions">
        <button class="btn warn tiny" onclick="openEdit('${r.id}')">Mod.</button>
        <button class="btn danger tiny" onclick="delItem('${r.id}')">X</button>
      </div>
    </td>
  </tr>`;
      }).join("");

      tabella.classList.toggle("hidden", rows.length === 0);
      
      const tot = rows.reduce((s,r)=>s+(Number(r.provvigioni)||0),0);
      const totImp = rows.reduce((s,r)=>s+(Number(r.premioImponibile)||0),0);
      
      totaleBox.innerHTML = `Totale Provvigioni Extra: <b>${money2(tot)}</b> | Volume Imponibile: <b>${money2(totImp)}</b>`;
      
      // Popola Anno filtro basandosi sulle date di decorrenza REALI
      const anni = [...new Set(rows.map(r => r.dataDecorrenza.split("-")[0]))].sort((a,b)=>b-a);
      if(fAnno.children.length<=1) fAnno.innerHTML = `<option value="">Tutti</option>` + anni.map(a=>`<option value="${a}">${a}</option>`).join("");
    }

    // GESTIONE AZIONI TABELLA
    tbody.addEventListener("change", async (ev) => {
      const el = ev.target;
      const action = el.dataset.action;
      const id = el.dataset.id;
      if (!action || !id) return;
      if(!isAdmin) return; 

      if (action === "togglePaid"){
        const checked = el.checked;
        const dateInput = tbody.querySelector(`input[data-action="paidDate"][data-id="${id}"]`);
        if(dateInput){
            dateInput.disabled = !checked;
            if(checked && !dateInput.value){
                const d = new Date();
                dateInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            }
            if(!checked) dateInput.value = "";
        }
        await updateDoc(doc(db, COL_EXTRA, id), {
            pagate: checked, 
            pagateData: checked ? dateInput.value : null 
        });
      }
      if (action === "paidDate"){
        const val = el.value;
        await updateDoc(doc(db, COL_EXTRA, id), { pagateData: val, pagate: !!val });
      }
    });

    window.delItem = async (id) => {
      if(!confirm("Eliminare definitivamente?")) return;
      await deleteDoc(doc(db, COL_EXTRA, id));
      loadByFilters();
    };

    // GESTIONE EDIT
    window.openEdit = (id) => {
      const row = lastResults.find(r=>r.id===id);
      if(!row) return;
      
      editId.value = row.id;
      editRamoSelect.value = row.ramo || "";
      editNomeCliente.value = row.nomeCliente || "";
      editDataDecorrenza.value = row.dataDecorrenza || "";
      editProduttoreSelect.value = row.produttore || "";
      editCompagniaSelect.value = row.compagnia || "";
      editTipoPolizzaSelect.value = row.tipoPolizza || "";
      editNumeroPolizza.value = row.numeroPolizza || "";
      editPremio.value = row.premio || "";
      editPremioImponibile.value = row.premioImponibile || "";
      
      const hasInc = (row.provvigioni > 0 && row.incentivazione !== "NESSUNA");
      editToggleIncentivi.value = hasInc ? "SI" : "NO";
      
      handleIncentiveToggle(editToggleIncentivi, editBoxIncentivi, [editIncentivazioneSelect, editPercentuale]);

      if(hasInc){
          editIncentivazioneSelect.value = row.incentivazione || "";
          editPercentuale.value = row.percentuale || "";
          editProvvigioni.value = row.provvigioni || "";
      } else {
          editIncentivazioneSelect.value = "";
          editPercentuale.value = "";
          editProvvigioni.value = "";
      }

      editModal.classList.remove("hidden");
    };
    btnChiudiModal.addEventListener("click", ()=>editModal.classList.add("hidden"));
    
    btnSalvaModifiche.addEventListener("click", async () => {
      const id = editId.value;
      if(!id) return;
      
      const hasInc = editToggleIncentivi.value === "SI";

      try{
        await updateDoc(doc(db, COL_EXTRA, id), {
          nomeCliente: editNomeCliente.value.trim(),
          dataDecorrenza: editDataDecorrenza.value,
          produttore: editProduttoreSelect.value,
          compagnia: editCompagniaSelect.value,
          tipoPolizza: editTipoPolizzaSelect.value,
          numeroPolizza: editNumeroPolizza.value.trim(),
          ramo: editRamoSelect.value,
          premio: toNumber(editPremio.value),
          premioImponibile: toNumber(editPremioImponibile.value),
          
          incentivazione: hasInc ? editIncentivazioneSelect.value : "NESSUNA",
          percentuale: hasInc ? toNumber(editPercentuale.value) : 0,
          provvigioni: hasInc ? toNumber(editProvvigioni.value) : 0,
          
          updatedAt: serverTimestamp()
        });
        editModal.classList.add("hidden");
        await loadByFilters();
        setMsg("ok", "Modifica salvata.");
      }catch(e){
        alert("Errore salvataggio modifica: " + e.message);
      }
    });

    // EXPORT EXCEL
    btnExportExcel.addEventListener("click", () => {
      if (!window.XLSX) return;
      const data = lastResults.map(r => ({
        "Data Ins.": r.dataiso, 
        "Cliente": r.nomeCliente, 
        "Ramo": r.ramo || "-",
        "Decorrenza": r.dataDecorrenza,
        "Produttore": r.produttore, 
        "Compagnia": r.compagnia, 
        "Tipo": r.tipoPolizza === "NUOVA" ? "Nuova Affari" : "Sostituzione",
        "Polizza": r.numeroPolizza,
        "Premio Lordo Annuo": r.premio, 
        "Premio Imp. Annuo": r.premioImponibile, 
        "Incentivazione": r.incentivazione,
        "% Extra": r.percentuale,
        "Provv. Extra": r.provvigioni, 
        "Pagate": r.pagate?"SI":"NO", 
        "Data Pag.": r.pagateData,
        "Utente": r.userEmail
      }));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "NuovaProduzione");
      XLSX.writeFile(wb, `Produzione_${new Date().getTime()}.xlsx`);
    });

    // BACKUP E RIPRISTINO
    const btnBackupDownload = document.getElementById("btnBackupDownload");
    const fileBackupInput = document.getElementById("fileBackupInput");
    const btnBackupRestore = document.getElementById("btnBackupRestore");

    async function getFullCollection(colName) {
      const snap = await getDocs(collection(db, colName)); 
      return snap.docs.map(d => ({ _id: d.id, ...d.data() }));
    }

    btnBackupDownload.addEventListener("click", async () => {
       if(!isAdmin && !confirm("Scaricherai solo i tuoi dati. Procedere?")) return;
       try {
        setMsg("warn", "Generazione backup...");
        const [prodData, incData, extraData] = await Promise.all([
          getFullCollection(COL_PROD),
          getFullCollection(COL_INC),
          getFullCollection(COL_EXTRA)
        ]);

        const backupBundle = {
          version: 1, timestamp: new Date().toISOString(),
          data: { produttori: prodData, incentivazioni: incData, extra: extraData }
        };
        const blob = new Blob([JSON.stringify(backupBundle, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Backup_Produzione_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setMsg("ok", "Backup completato.");
      } catch (e) { setMsg("err", "Errore backup: " + e.message); }
    });

    btnBackupRestore.addEventListener("click", () => {
       if(!isAdmin) return alert("Solo admin può ripristinare.");
       fileBackupInput.value = ""; fileBackupInput.click();
    });

    fileBackupInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const json = JSON.parse(event.target.result);
          if (!json.data || !json.data.extra) throw new Error("File non valido");
          if (!confirm(`Ripristinare ${json.data.extra.length} record?`)) return;
          
          setMsg("warn", "Ripristino...");
          const restore = async (col, items) => {
            const promises = items.map(i => {
               const { _id, ...d } = i;
               return setDoc(doc(db, col, _id), d);
            });
            await Promise.all(promises);
          };
          await restore(COL_PROD, json.data.produttori);
          await restore(COL_INC, json.data.incentivazioni);
          await restore(COL_EXTRA, json.data.extra);
          setMsg("ok", "Ripristino completato.");
          await init();
        } catch (err) { setMsg("err", "Errore file: " + err.message); }
      };
      reader.readAsText(file);
    });
    
    // INIT
    async function init(){
      await loadProduttori();
      await loadIncentivazioni();
      await loadByFilters();
    }
  </script>
</body>
</html>
